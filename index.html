<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Abyss Survivors: Teal Edition</title>
    <style>
        /* 1. ì‹¬ì—° í…Œë§ˆ (Teal/Cyan #00a588 Based) */
        :root {
            /* ë°°ê²½: ìˆœìˆ˜ ê²€ì • ì§€ì–‘, ê¹Šì€ ì²­ë¡ë¹›ì´ ê°ë„ëŠ” ì–´ë‘ìš´ íšŒìƒ‰ */
            --bg-color: #0a0c0d;
            --container-bg: #121517;
            --panel-bg: #1e2224;
            
            /* í¬ì¸íŠ¸ ì»¬ëŸ¬: ìš”ì²­í•˜ì‹  #00a588 ë° íŒŒìƒ ìƒ‰ìƒ */
            --main-accent: #00a588;    /* ë©”ì¸ (ì²­ë¡) */
            --bright-accent: #64ffda;  /* í•˜ì´ë¼ì´íŠ¸/ê¸€ì”¨ (í˜•ê´‘ ë¯¼íŠ¸) */
            --hover-accent: #00bfa5;   /* ë²„íŠ¼ í˜¸ë²„ */
            
            --text-main: #eceff1;
            --text-sub: #90a4ae;
            
            --hp-color: #e53935;       /* ì²´ë ¥ (ë¶‰ì€ìƒ‰) */
            --san-color: #8e24aa;      /* ì´ì„± (ë³´ë¼ìƒ‰) */
            --food-color: #ffb300;     /* í—ˆê¸° (ì§„í•œ ë…¸ë‘) */
            
            --btn-bg: #263238;
            --btn-hover: #37474f;
            
            --border-color: #37474f;
        }

        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .container { 
            max-width: 1400px; margin: 0 auto; 
            background: var(--container-bg); 
            height: 100%; border-radius: 6px; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 165, 136, 0.15); /* ì€ì€í•œ ì²­ë¡ìƒ‰ ë¹› */
        }

        .header { 
            padding: 15px 25px; border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; display:flex; justify-content:space-between; align-items:center;
            background: linear-gradient(90deg, var(--container-bg), #080a0a);
        }
        h1 { margin: 0; color: var(--bright-accent); font-size: 1.5em; text-shadow: 0 0 15px rgba(100, 255, 218, 0.4); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* 2ë‹¨ ë ˆì´ì•„ì›ƒ */
        #page-sim.active { display: flex; gap: 20px; padding: 20px; overflow: hidden; }
        .sim-left { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .sim-right { 
            flex: 1; display: flex; flex-direction: column; overflow-y: auto; 
            min-width: 380px; gap: 20px; padding-right: 5px;
        }

        /* ë¡œê·¸ ì°½ */
        #log-window { 
            flex-grow: 1; overflow-y: auto; 
            background: #0f1112;
            border: 1px solid var(--border-color); 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 0.95em; 
            border-radius: 4px; color: #b0bec5;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #1c2224; padding-bottom: 6px; line-height: 1.6; }
        .txt-day { color: var(--main-accent); font-weight: bold; border: 1px solid var(--main-accent); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; background: rgba(0, 165, 136, 0.1); }
        .txt-threat { color: #ff5252; }
        .txt-item { color: #ffd54f; }
        .txt-info { color: #4fc3f7; }

        /* ê³µìš© ì¸ë²¤í† ë¦¬ */
        .inventory-box {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 4px;
        }
        .inv-title { font-weight: bold; color: var(--bright-accent); margin-bottom: 12px; display:block; border-bottom:1px solid var(--border-color); padding-bottom:5px;}
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .item-btn { 
            background: var(--btn-bg); color: #cfd8dc; border: 1px solid #455a64;
            padding: 6px 12px; font-size: 0.85em; cursor: pointer; border-radius: 2px;
            transition: all 0.2s;
        }
        .item-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; box-shadow: 0 0 10px rgba(0, 165, 136, 0.5); }

        /* ìºë¦­í„° ì¹´ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .char-card { 
            background: var(--panel-bg); border: 1px solid var(--border-color); padding: 15px; 
            border-left: 3px solid #37474f; border-radius: 4px;
            position: relative; transition: border-color 0.3s;
        }
        .char-card:hover { border-color: var(--main-accent); }
        .char-card.danger { border-left-color: var(--hp-color); }
        .char-card.madness { border-left-color: var(--san-color); }

        .char-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-end; }
        .char-name { font-weight: bold; font-size: 1.1em; color: var(--bright-accent); }
        .char-meta { font-size: 0.8em; color: var(--text-sub); }

        /* ê·¸ë˜í”„ ë°” ìŠ¤íƒ€ì¼ (ëš«ë¦¼ ë°©ì§€ ì ìš©ë¨) */
        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #90a4ae; margin-top: 6px; }
        .bar-bg { 
            flex-grow: 1; background: #263238; height: 6px; margin: 0 10px; 
            border-radius: 2px; overflow: hidden; 
        }
        .bar-fill { height: 100%; transition: width 0.4s ease-out; max-width: 100%; }

        /* ëª¨ë‹¬ì°½ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 12, 13, 0.9); z-index: 1000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--panel-bg); border: 2px solid var(--main-accent); padding: 25px;
            width: 420px; max-width: 90%; border-radius: 6px; 
            box-shadow: 0 0 30px rgba(0, 165, 136, 0.3);
            text-align: center;
        }
        .modal-title { color: var(--bright-accent); font-size: 1.3em; margin-bottom: 10px; font-weight: bold; }
        .modal-desc { color: #ccc; margin-bottom: 25px; font-size: 0.95em; line-height: 1.5; }
        .target-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        
        .target-btn {
            background: var(--btn-bg); border: 1px solid var(--border-color); color: #eceff1; padding: 12px; cursor: pointer;
            border-radius: 4px; transition: 0.2s;
        }
        .target-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; }
        .target-btn.dead { opacity: 0.4; pointer-events: none; text-decoration: line-through; border-color: #444; }

        .modal-close { background: transparent; border: 1px solid #ef5350; color: #ef5350; padding: 8px 25px; cursor: pointer; border-radius: 4px; }
        .modal-close:hover { background: #c62828; color: white; border-color: #c62828; }

        /* ë²„íŠ¼ */
        .btn-main { 
            background: var(--main-accent); color: white; border: none; padding: 12px 20px; 
            font-weight: bold; cursor: pointer; font-size: 1em; width: 100%; margin-bottom: 10px; 
            border-radius: 4px; transition: 0.2s;
        }
        .btn-main:hover { background: var(--hover-accent); box-shadow: 0 0 15px rgba(0, 165, 136, 0.6); }
        .btn-sub { background: var(--btn-bg); color: var(--text-sub); border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
        .btn-sub:hover { background: var(--btn-hover); color: white; }

        /* ì…ë ¥ í¼ */
        .input-section { background: rgba(38, 50, 56, 0.3); padding: 20px; border:1px solid var(--border-color); border-radius: 4px;}
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { 
            width: 100%; padding: 12px; background: #161b1d; 
            border: 1px solid var(--border-color); color: white; border-radius: 2px;
        }
        input:focus, select:focus { border-color: var(--main-accent); outline: none; box-shadow: 0 0 5px rgba(0, 165, 136, 0.5); }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ Abyss Survivors</h1>
            <div id="setup-btn-group" style="display:none;">
                <button class="btn-sub" onclick="stopGame()">âš™ï¸ ì¢…ë£Œ</button>
            </div>
        </div>

        <div id="page-setup" class="page active">
            <div style="max-width: 800px; margin: 0 auto;">
                <p style="color:var(--text-sub); margin-bottom: 20px;">ì‹¬ì—°ì—ì„œ ì‚´ì•„ë‚¨ì„ íƒì‚¬ìë¥¼ ë“±ë¡í•˜ì‹­ì‹œì˜¤.</p>
                
                <div class="input-section">
                    <div class="input-group">
                        <input type="text" id="input-name" placeholder="íƒì‚¬ì ì´ë¦„ (Ex. K)">
                        <select id="input-mbti">
                            <option value="INTJ">INTJ (ëƒ‰ì² í•œ ì „ëµê°€)</option>
                            <option value="INTP">INTP (ì‹¬ì—°ì˜ ì—°êµ¬ê°€)</option>
                            <option value="INFJ">INFJ (ê³ ë‡Œí•˜ëŠ” ì˜ˆì–¸ì)</option>
                            <option value="ISTP">ISTP (ëƒ‰ì†Œì ì¸ í•´ê²°ì‚¬)</option>
                            <option value="ESTJ">ESTJ (ê°•ì••ì ì¸ ì§€íœ˜ê´€)</option>
                            <option value="ESTP">ESTP (ë¬´ëª¨í•œ ëª¨í—˜ê°€)</option>
                            <option value="ENFJ">ENFJ (ê´‘ê¸°ì˜ ì„ ë™ê°€)</option>
                            <option value="ENTP">ENTP (ë¯¸ì¹˜ê´‘ì´ ë°œëª…ê°€)</option>
                            <option value="ISFP">ISFP (ì¡°ìš©í•œ ê´€ì°°ì)</option>
                        </select>
                    </div>
                    <button class="btn-main" onclick="addCharacter()">íƒì‚¬ì ëª…ë‹¨ ì¶”ê°€</button>
                </div>

                <div id="setup-list" class="char-grid"></div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn-main" style="padding: 15px 30px; font-size: 1.2em; width:auto;" onclick="startGame()">ğŸ² ì‹¬ì—°ìœ¼ë¡œ ì§„ì… (Start Session)</button>
                </div>
            </div>
        </div>

        <div id="page-sim" class="page">
            <div class="sim-left">
                <button class="btn-main" onclick="nextTurn()">ğŸŒ™ ë‹¤ìŒ ë‚  (Next Day)</button>
                <div id="log-window">
                    <div class="log-entry" style="color:#607d8b;">...ê¸°ë¡ ì‹œìŠ¤í…œ ê°€ë™...</div>
                </div>
            </div>
            <div class="sim-right">
                <div class="inventory-box">
                    <span class="inv-title">ğŸ“¦ ê³µìš© ë¬¼ì (Shared Supply)</span>
                    <div id="shared-inv" class="inv-grid">
                        <span style="color:#607d8b; font-size:0.9em; padding:10px;">..ë¬¼ìê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤..</span>
                    </div>
                </div>
                <div id="sim-char-list" class="char-grid"></div>
            </div>
        </div>
    </div>

    <div id="item-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">ì•„ì´í…œ ì‚¬ìš©</div>
            <div id="modal-desc" class="modal-desc">ëŒ€ìƒ ì„ íƒ</div>
            <div id="modal-targets" class="target-list"></div>
            <button class="modal-close" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // (ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì€ ì´ì „ ë²„ì „ê³¼ ë™ì¼í•˜ì—¬ ìƒëµ ì—†ì´ ì „ì²´ í¬í•¨)
        // ==========================================
        const MAX_STAT_CAP = 100; 
        
        const ITEMS = [
            { name: "ì‘ê¸‰ í‚¤íŠ¸", type: "hp", val: 30, desc: "ì°¢ì–´ì§„ ì‚´ì„ ë´‰í•©í•©ë‹ˆë‹¤. (HP +30)" },
            { name: "ë…¹ìŠ¨ í†µì¡°ë¦¼", type: "food", val: 40, desc: "ë¹„ë¦¿í•˜ì§€ë§Œ ë°°ëŠ” ì±„ì›ë‹ˆë‹¤. (ì‹ëŸ‰ +40)" },
            { name: "ì§„ì •ì œ", type: "sanity", val: 20, desc: "ë–¨ë¦¬ëŠ” ì†ì„ ë©ˆì¶¥ë‹ˆë‹¤. (ì´ì„± +20)" },
            { name: "ì •í™”ìˆ˜", type: "food", val: 25, desc: "ì˜¤ì—¼ë˜ì§€ ì•Šì€ ë¬¼ì…ë‹ˆë‹¤. (ì‹ëŸ‰ +25)" },
            { name: "ì—˜ë” ì‚¬ì¸", type: "sanity", val: 40, desc: "ê³ ëŒ€ í‘œì‹ì´ ë§ˆìŒì„ ë³´í˜¸í•©ë‹ˆë‹¤. (ì´ì„± +40)" },
            { name: "êµ°ìš© ìŠ¤íŒ€íŒ©", type: "hp", val: 15, desc: "ê³ í†µì„ ì ì‹œ ìŠê²Œ í•©ë‹ˆë‹¤. (HP +15)" }
        ];

        const THREATS = [
            { name: "ë¹„ìœ í´ë¦¬ë“œ ë¯¸ë¡œ", power: 70, text: "ê³µê°„ì´ ë’¤í‹€ë ¤ ì¶œêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { name: "ì‹¬í•´ì¸(Deep One)", power: 110, text: "ì¶•ì¶•í•œ ë¹„ëŠ˜ì„ ê°€ì§„ ê´´ë¬¼ë“¤ì´ ìŠµê²©í•©ë‹ˆë‹¤." },
            { name: "ê²€ì€ ì•ˆê°œ", power: 90, text: "ì•ˆê°œ ì†ì—ì„œ ì†ì‚­ì„ì´ ë“¤ë ¤ì™€ ì •ì‹ ì„ ê°‰ì•„ë¨¹ìŠµë‹ˆë‹¤." },
            { name: "ì‡¼ê³ ìŠ¤", power: 140, text: "í˜•ì²´ ì—†ëŠ” ì ì•¡ì§ˆ ê´´ë¬¼ì´ ë®ì³ì˜µë‹ˆë‹¤. í…Œì¼ˆë¦¬-ë¦¬!" },
            { name: "ê´‘ì‹ ë„ ë¬´ë¦¬", power: 80, text: "ì£¼ë¬¸ì„ ì™¸ìš°ëŠ” ê´‘ì‹ ë„ë“¤ê³¼ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤." }
        ];

        let characters = [];
        let partyInventory = [];
        let day = 0;
        let selectedItemIndex = -1;

        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            let stats = {
                hp: 100, maxHp: 100,
                sanity: 100, maxSanity: 100,
                food: 100, maxFood: 100,
                power: 20 + Math.floor(Math.random()*30),
                obs: 20 + Math.floor(Math.random()*30)
            };

            if(mbti.includes('T')) stats.power += 20;
            if(mbti.includes('N')) stats.obs += 20;

            characters.push({ id: Date.now(), name: name, mbti: mbti, stats: stats, relations: {} });
            document.getElementById('input-name').value = '';
            renderSetupList();
        }

        function renderSetupList() {
            const div = document.getElementById('setup-list');
            div.innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-header"><span class="char-name">${c.name}</span> <span class="char-meta">${c.mbti}</span></div>
                    <div class="char-meta">ì „íˆ¬ë ¥: ${c.stats.power} / ê´€ì°°ë ¥: ${c.stats.obs}</div>
                </div>
            `).join('');
        }

        function startGame() {
            if(characters.length < 1) return alert("ìµœì†Œ 1ëª…ì˜ íƒì‚¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'block';
            partyInventory.push(ITEMS[0]); partyInventory.push(ITEMS[1]);
            addLog("ğŸ“¢ ì‹¬ì—°ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœëŠ” ì–‘í˜¸í•©ë‹ˆë‹¤.");
            updateUI();
        }

        function stopGame() {
            if(!confirm("ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  ì´ˆê¸°í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            document.getElementById('page-sim').classList.remove('active');
            document.getElementById('page-setup').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'none';
        }

        function nextTurn() {
            day++;
            addLog(`<div style="margin: 20px 0 10px 0;"><span class="txt-day">Day ${day}</span> ì–´ë‘  ì†ì—ì„œ í•˜ë£¨ê°€ ì§€ë‚¬ìŠµë‹ˆë‹¤.</div>`);
            const survivors = characters.filter(c => c.stats.hp > 0);
            if(survivors.length === 0) {
                addLog("<div style='color:#ef5350; font-size:1.2em; margin-top:10px;'>ğŸ’€ ëª¨ë“  íƒì‚¬ìê°€ ì‹¬ì—°ì— ì ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. (Game Over)</div>");
                return;
            }
            survivors.forEach(c => {
                c.stats.food -= 15;
                if(c.stats.food < 0) { c.stats.food = 0; c.stats.hp -= 10; addLog(`<span class="txt-info">.. ${c.name}: ê·¹ì‹¬í•œ í—ˆê¸°ë¡œ ì²´ë ¥ ê°ì†Œ (-10)</span>`); }
            });
            const roll = Math.random();
            if(roll < 0.35) processScavenge(survivors);
            else if(roll < 0.65) processThreat(survivors);
            else processRest(survivors);
            updateUI();
        }

        function processScavenge(survivors) {
            addLog(`<span style="color:#fdd835;">[íƒìƒ‰]</span> ê²€ì€ íí—ˆë¥¼ ë’¤ì§‘ë‹ˆë‹¤...`);
            let found = false;
            survivors.forEach(c => {
                if(Math.random() * 100 < c.stats.obs + 15) {
                    const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                    partyInventory.push({...item}); addLog(`.. ğŸ” <b>${c.name}</b>: [${item.name}] ë°œê²¬.`); found = true;
                }
            });
            if(!found) addLog(`.. ë¨¼ì§€ì™€ ì¬ ë§ê³ ëŠ” ì•„ë¬´ê²ƒë„ ì—†ìŠµë‹ˆë‹¤.`);
        }

        function processThreat(survivors) {
            const threat = THREATS[Math.floor(Math.random() * THREATS.length)];
            addLog(`<span class="txt-threat">[ìœ„í˜‘] ${threat.text} (ë‚œì´ë„: ${threat.power})</span>`);
            let teamPower = survivors.reduce((sum, c) => sum + c.stats.power, 0) + (Math.random() * 50);
            if(teamPower >= threat.power) {
                addLog(`.. âœ… ì „ì›ì´ í˜ì„ í•©ì³ ìœ„í˜‘ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤!`);
                survivors.forEach(c => updateStat(c, 'sanity', -5));
            } else {
                addLog(`.. âŒ ë°©ì–´ ì‹¤íŒ¨! ë¬´ìë¹„í•œ ê³µê²©ì„ ë°›ìŠµë‹ˆë‹¤.`);
                const dmg = 20; survivors.forEach(c => { updateStat(c, 'hp', -dmg); updateStat(c, 'sanity', -10); addLog(`.. ${c.name} (HP -${dmg}, SAN -10)`); });
            }
        }

        function processRest(survivors) {
            addLog(`<span style="color:#81d4fa;">[íœ´ì‹]</span> ì ì‹œ ì•ˆì „í•œ ê³³ì—ì„œ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤.`);
            survivors.forEach(c => updateStat(c, 'sanity', 5));
        }

        function updateStat(char, type, amount) {
            if (char.stats.hp <= 0 && type !== 'hp') return;
            let newVal = char.stats[type] + amount;
            let maxKey = 'max' + type.charAt(0).toUpperCase() + type.slice(1);
            let maxVal = char.stats[maxKey] || 100;
            char.stats[type] = Math.max(0, Math.min(maxVal, newVal));
        }

        function requestItemUse(idx) {
            selectedItemIndex = idx;
            const item = partyInventory[idx];
            const modal = document.getElementById('item-modal');
            document.getElementById('modal-title').innerText = `[${item.name}] ì‚¬ìš©`;
            document.getElementById('modal-desc').innerText = `${item.desc}\n\nëˆ„êµ¬ì—ê²Œ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            const listDiv = document.getElementById('modal-targets');
            listDiv.innerHTML = characters.map(c => {
                const isDead = c.stats.hp <= 0;
                return `<div class="target-btn ${isDead?'dead':''}" onclick="confirmUseItem(${c.id})">${c.name} <br><span style="font-size:0.8em; color:#90a4ae;">HP:${c.stats.hp}/${c.stats.maxHp} SAN:${c.stats.sanity}/${c.stats.maxSanity}</span></div>`;
            }).join('');
            modal.style.display = 'flex';
        }

        function confirmUseItem(charId) {
            if(selectedItemIndex === -1) return;
            const item = partyInventory[selectedItemIndex];
            const char = characters.find(c => c.id === charId);
            if(char) {
                updateStat(char, item.type, item.val);
                addLog(`<span class="txt-info">ğŸ’Š <b>${char.name}</b>ì—ê²Œ [${item.name}] ì‚¬ìš© ì™„ë£Œ.</span>`);
                partyInventory.splice(selectedItemIndex, 1);
            }
            closeModal(); updateUI();
        }

        function closeModal() { document.getElementById('item-modal').style.display = 'none'; selectedItemIndex = -1; }

        function updateUI() {
            const charDiv = document.getElementById('sim-char-list');
            charDiv.innerHTML = characters.map(c => {
                const isDead = c.stats.hp <= 0;
                const hpPct = Math.min(100, (c.stats.hp / c.stats.maxHp) * 100);
                const sanPct = Math.min(100, (c.stats.sanity / c.stats.maxSanity) * 100);
                const foodPct = Math.min(100, (c.stats.food / c.stats.maxFood) * 100);
                let classes = "char-card";
                if(c.stats.sanity < 30) classes += " madness";
                if(c.stats.hp < 30) classes += " danger";
                if(isDead) return `<div class="char-card" style="opacity:0.3; filter:grayscale(100%); border-color:#37474f;"><div class="char-header"><span class="char-name" style="color:#b0bec5;">ğŸ’€ ${c.name} (ì‚¬ë§)</span></div></div>`;
                return `
                <div class="${classes}">
                    <div class="char-header"><span class="char-name">${c.name}</span><span class="char-meta">${c.mbti}</span></div>
                    <div class="stat-row"><span>HP</span> <div class="bar-bg"><div class="bar-fill" style="width:${hpPct}%; background:var(--hp-color)"></div></div> <span>${c.stats.hp}</span></div>
                    <div class="stat-row"><span>SAN</span> <div class="bar-bg"><div class="bar-fill" style="width:${sanPct}%; background:var(--san-color)"></div></div> <span>${c.stats.sanity}</span></div>
                    <div class="stat-row"><span>FOOD</span> <div class="bar-bg"><div class="bar-fill" style="width:${foodPct}%; background:var(--food-color)"></div></div> <span>${c.stats.food}</span></div>
                </div>`;
            }).join('');

            const invDiv = document.getElementById('shared-inv');
            if(partyInventory.length === 0) { invDiv.innerHTML = `<span style="color:#607d8b; font-size:0.9em; padding:10px;">..ë¬¼ìê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤..</span>`; } 
            else { invDiv.innerHTML = partyInventory.map((item, idx) => `<button class="item-btn" onclick="requestItemUse(${idx})" title="${item.desc}">${item.name}</button>`).join(''); }
            const logWin = document.getElementById('log-window'); logWin.scrollTop = logWin.scrollHeight;
        }

        function addLog(html) {
            const win = document.getElementById('log-window');
            const div = document.createElement('div'); div.className = 'log-entry'; div.innerHTML = html;
            win.appendChild(div);
        }
    </script>
</body>
</html>
