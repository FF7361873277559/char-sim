<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Abyss Survivors: Complete</title>
    <style>
        /* =========================================
           1. í…Œë§ˆ ì„¤ì • (Teal #00a588 Dark Theme)
           ========================================= */
        :root {
            --bg-color: #0a0c0d;
            --container-bg: #121517;
            --panel-bg: #1e2224;
            
            --main-accent: #00a588;    /* ë©”ì¸ (ì²­ë¡) */
            --bright-accent: #64ffda;  /* í…ìŠ¤íŠ¸ ê°•ì¡° (í˜•ê´‘ ë¯¼íŠ¸) */
            --hover-accent: #00bfa5;
            
            --text-main: #eceff1;
            --text-sub: #90a4ae;
            
            --hp-color: #ef5350;       /* ì²´ë ¥ */
            --san-color: #ab47bc;      /* ì´ì„± */
            --food-color: #ffca28;     /* í—ˆê¸° */
            
            --btn-bg: #263238;
            --border-color: #37474f;
        }

        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }

        /* ë ˆì´ì•„ì›ƒ êµ¬ì¡° */
        .container { 
            max-width: 1400px; margin: 0 auto; 
            background: var(--container-bg); 
            height: 100%; border-radius: 6px; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 165, 136, 0.1);
        }

        .header { 
            padding: 15px 25px; border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; display:flex; justify-content:space-between; align-items:center;
            background: linear-gradient(90deg, #0f1214, #15191b);
        }
        h1 { margin: 0; color: var(--bright-accent); font-size: 1.5em; text-shadow: 0 0 10px rgba(0, 165, 136, 0.5); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ (ì¢Œìš° ë¶„í• ) */
        #page-sim.active { display: flex; gap: 20px; padding: 20px; overflow: hidden; }
        .sim-left { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .sim-right { 
            flex: 1; display: flex; flex-direction: column; overflow-y: auto; 
            min-width: 380px; gap: 20px; padding-right: 5px;
        }

        /* ë¡œê·¸ ì°½ */
        #log-window { 
            flex-grow: 1; overflow-y: auto; 
            background: #0d1011; border: 1px solid var(--border-color); 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 0.95em; 
            border-radius: 4px; color: #b0bec5; line-height: 1.6;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #1c2224; padding-bottom: 6px; }
        .txt-day { color: var(--main-accent); font-weight: bold; border: 1px solid var(--main-accent); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .txt-threat { color: #ff5252; }
        .txt-item { color: #ffb74d; }
        .txt-info { color: #4fc3f7; }

        /* ê³µìš© ì¸ë²¤í† ë¦¬ */
        .inventory-box {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 4px;
        }
        .inv-title { font-weight: bold; color: var(--bright-accent); margin-bottom: 12px; display:block; border-bottom:1px solid var(--border-color); padding-bottom:5px;}
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .item-btn { 
            background: var(--btn-bg); color: #cfd8dc; border: 1px solid #455a64;
            padding: 6px 12px; font-size: 0.85em; cursor: pointer; border-radius: 2px;
            transition: all 0.2s;
        }
        .item-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; box-shadow: 0 0 8px rgba(0, 165, 136, 0.4); }

        /* ìºë¦­í„° ì¹´ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .char-card { 
            background: var(--panel-bg); border: 1px solid var(--border-color); padding: 15px; 
            border-left: 3px solid #37474f; border-radius: 4px;
            position: relative; transition: border-color 0.3s;
        }
        .char-card.danger { border-left-color: var(--hp-color); }
        .char-card.madness { border-left-color: var(--san-color); }

        .char-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-end; }
        .char-name { font-weight: bold; font-size: 1.1em; color: var(--bright-accent); }
        .char-meta { font-size: 0.75em; color: var(--text-sub); text-align: right;}

        /* ê·¸ë˜í”„ ë°” */
        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #90a4ae; margin-top: 5px; }
        .bar-bg { 
            flex-grow: 1; background: #263238; height: 6px; margin: 0 10px; 
            border-radius: 2px; overflow: hidden; 
        }
        .bar-fill { height: 100%; transition: width 0.4s ease-out; max-width: 100%; }
        
        /* ëŠ¥ë ¥ì¹˜ ìƒì„¸ ì •ë³´ (New) */
        .attr-box { 
            display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; 
            border-top: 1px dashed #37474f; font-size: 0.8em; color: #78909c;
        }

        /* ì…ë ¥ í¼ (Setup) */
        .input-section { background: rgba(38, 50, 56, 0.3); padding: 25px; border:1px solid var(--border-color); border-radius: 6px;}
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { 
            width: 100%; padding: 12px; background: #161b1d; 
            border: 1px solid var(--border-color); color: white; border-radius: 2px;
        }
        input:focus, select:focus { border-color: var(--main-accent); outline: none; }

        /* ìŠ¤íƒ¯ ë¶„ë°° ë°•ìŠ¤ (Restored) */
        .stat-dist-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .stat-input-group label { display: block; text-align: center; font-size: 0.8em; color: var(--text-sub); margin-bottom: 5px; }
        .stat-input-group input { text-align: center; font-weight: bold; color: var(--bright-accent); }
        .remain-point { text-align: right; font-size: 0.9em; margin-bottom: 5px; color: var(--text-sub); }

        /* ëª¨ë‹¬ì°½ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 12, 13, 0.9); z-index: 1000;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .modal-box {
            background: var(--panel-bg); border: 1px solid var(--main-accent); padding: 25px;
            width: 450px; max-width: 90%; border-radius: 6px; 
            box-shadow: 0 0 30px rgba(0, 165, 136, 0.2); text-align: center;
        }
        .target-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .target-btn {
            background: var(--btn-bg); border: 1px solid var(--border-color); color: #eceff1; padding: 10px; cursor: pointer;
            border-radius: 4px; transition: 0.2s; font-size: 0.9em;
        }
        .target-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; }
        .target-btn.dead { opacity: 0.4; pointer-events: none; text-decoration: line-through; }

        /* ê³µí†µ ë²„íŠ¼ */
        .btn-main { 
            background: var(--main-accent); color: white; border: none; padding: 12px 20px; 
            font-weight: bold; cursor: pointer; font-size: 1em; width: 100%; border-radius: 4px; transition: 0.2s;
        }
        .btn-main:hover { background: var(--hover-accent); box-shadow: 0 0 15px rgba(0, 165, 136, 0.4); }
        .btn-sub { background: var(--btn-bg); color: var(--text-sub); border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ Abyss Survivors</h1>
            <div id="setup-btn-group" style="display:none;">
                <button class="btn-sub" onclick="stopGame()">âš™ï¸ ì¢…ë£Œ</button>
            </div>
        </div>

        <div id="page-setup" class="page active">
            <div style="max-width: 800px; margin: 0 auto;">
                <p style="color:var(--text-sub); margin-bottom: 20px;">ì‹¬ì—°ì—ì„œ ì‚´ì•„ë‚¨ì„ íƒì‚¬ìë¥¼ ë“±ë¡í•˜ì‹­ì‹œì˜¤.</p>
                
                <div class="input-section">
                    <div class="input-group">
                        <div style="flex:1">
                            <input type="text" id="input-name" placeholder="íƒì‚¬ì ì´ë¦„ (ì˜ˆ: K)">
                        </div>
                        <div style="flex:1">
                            <select id="input-mbti">
                                <option value="INTJ">INTJ (ì „ëµê°€)</option>
                                <option value="INTP">INTP (ì—°êµ¬ê°€)</option>
                                <option value="INFJ">INFJ (ì˜ˆì–¸ì)</option>
                                <option value="INFP">INFP (ëª½ìƒê°€)</option>
                                <option value="ISTJ">ISTJ (ê´€ë¦¬ì)</option>
                                <option value="ISFJ">ISFJ (ìˆ˜í˜¸ì)</option>
                                <option value="ISTP">ISTP (ê¸°ìˆ ì)</option>
                                <option value="ISFP">ISFP (ì˜ˆìˆ ê°€)</option>
                                <option value="ENTJ">ENTJ (í†µì†”ì)</option>
                                <option value="ENTP">ENTP (ë³€ë¡ ê°€)</option>
                                <option value="ENFJ">ENFJ (ìš´ë™ê°€)</option>
                                <option value="ENFP">ENFP (í™œë™ê°€)</option>
                                <option value="ESTJ">ESTJ (ê²½ì˜ì)</option>
                                <option value="ESTP">ESTP (ì‚¬ì—…ê°€)</option>
                                <option value="ESFJ">ESFJ (ì™¸êµê´€)</option>
                                <option value="ESFP">ESFP (ììœ ì¸)</option>
                            </select>
                        </div>
                    </div>

                    <div class="remain-point">ì”ì—¬ í¬ì¸íŠ¸: <span id="remain-val" style="color:var(--bright-accent); font-weight:bold;">100</span> / 100</div>
                    <div class="stat-dist-box">
                        <div class="stat-input-group">
                            <label>ê·¼ë ¥<br>(STR)</label>
                            <input type="number" id="stat-str" value="0" min="0" oninput="checkPoints()">
                        </div>
                        <div class="stat-input-group">
                            <label>ë¯¼ì²©<br>(AGI)</label>
                            <input type="number" id="stat-agi" value="0" min="0" oninput="checkPoints()">
                        </div>
                        <div class="stat-input-group">
                            <label>íˆ¬ì§€<br>(POW)</label>
                            <input type="number" id="stat-pow" value="0" min="0" oninput="checkPoints()">
                        </div>
                        <div class="stat-input-group">
                            <label>ê´€ì°°<br>(OBS)</label>
                            <input type="number" id="stat-obs" value="0" min="0" oninput="checkPoints()">
                        </div>
                    </div>
                    <div id="point-error" style="color:#ef5350; font-size:0.9em; display:none; text-align:right;">âš ï¸ í•©ê³„ê°€ 100ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>

                    <button class="btn-main" onclick="addCharacter()" style="margin-top:15px;">íƒì‚¬ì ë“±ë¡</button>
                </div>

                <div id="setup-list" class="char-grid" style="margin-top:20px;"></div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn-main" style="padding: 15px 30px; font-size: 1.2em; width:auto;" onclick="startGame()">ğŸ² ì‹¬ì—° ì§„ì… (Start Session)</button>
                </div>
            </div>
        </div>

        <div id="page-sim" class="page">
            <div class="sim-left">
                <button class="btn-main" onclick="nextTurn()">ğŸŒ™ í•˜ë£¨ë¥¼ ë²„í‹´ë‹¤ (Next Day)</button>
                <div id="log-window">
                    <div class="log-entry" style="color:#546e7a;">ê¸°ë¡ ì¥ì¹˜ ê°€ë™...</div>
                </div>
            </div>
            <div class="sim-right">
                <div class="inventory-box">
                    <span class="inv-title">ğŸ“¦ ê³µìš© ë¬¼ì (Shared Supply)</span>
                    <div id="shared-inv" class="inv-grid">
                        <span style="color:#546e7a; padding:10px; font-size:0.9em;">ë¹„ì–´ìˆìŒ</span>
                    </div>
                </div>
                <div id="sim-char-list" class="char-grid"></div>
            </div>
        </div>
    </div>

    <div id="item-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="color:var(--bright-accent); margin-top:0;"></h3>
            <p id="modal-desc" style="color:#ccc; font-size:0.9em;"></p>
            <div id="modal-targets" class="target-list"></div>
            <button class="btn-sub" onclick="closeModal()" style="border:1px solid #ef5350; color:#ef5350;">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 0. ìƒìˆ˜ ë° ì„¤ì •
        // ==========================================
        const MAX_POINTS = 100;
        
        const ITEMS = [
            { name: "ì‘ê¸‰ í‚¤íŠ¸", type: "hp", val: 30, desc: "ì°¢ì–´ì§„ ì‚´ì„ ë´‰í•©í•©ë‹ˆë‹¤. (HP +30)" },
            { name: "ë…¹ìŠ¨ í†µì¡°ë¦¼", type: "food", val: 40, desc: "ë¹„ë¦¿í•˜ì§€ë§Œ ë°°ëŠ” ì±„ì›ë‹ˆë‹¤. (ì‹ëŸ‰ +40)" },
            { name: "ì§„ì •ì œ", type: "sanity", val: 20, desc: "ë–¨ë¦¬ëŠ” ì†ì„ ë©ˆì¶¥ë‹ˆë‹¤. (ì´ì„± +20)" },
            { name: "ì •í™”ìˆ˜", type: "food", val: 25, desc: "ì˜¤ì—¼ë˜ì§€ ì•Šì€ ë¬¼ì…ë‹ˆë‹¤. (ì‹ëŸ‰ +25)" },
            { name: "ì—˜ë” ì‚¬ì¸", type: "sanity", val: 40, desc: "ê³ ëŒ€ í‘œì‹ì´ ë§ˆìŒì„ ë³´í˜¸í•©ë‹ˆë‹¤. (ì´ì„± +40)" },
            { name: "êµ°ìš© ìŠ¤íŒ€íŒ©", type: "hp", val: 15, desc: "ê³ í†µì„ ì ì‹œ ìŠê²Œ í•©ë‹ˆë‹¤. (HP +15)" }
        ];

        const THREATS = [
            { name: "ë¹„ìœ í´ë¦¬ë“œ ë¯¸ë¡œ", power: 90, text: "ê³µê°„ì´ ë’¤í‹€ë ¤ ì¶œêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { name: "ì‹¬í•´ì¸(Deep One)", power: 120, text: "ì¶•ì¶•í•œ ë¹„ëŠ˜ì„ ê°€ì§„ ê´´ë¬¼ë“¤ì´ ìŠµê²©í•©ë‹ˆë‹¤." },
            { name: "ê²€ì€ ì•ˆê°œ", power: 80, text: "ì•ˆê°œ ì†ì—ì„œ ì†ì‚­ì„ì´ ë“¤ë ¤ì™€ ì •ì‹ ì„ ê°‰ì•„ë¨¹ìŠµë‹ˆë‹¤." },
            { name: "ì‡¼ê³ ìŠ¤", power: 150, text: "í˜•ì²´ ì—†ëŠ” ì ì•¡ì§ˆ ê´´ë¬¼ì´ ë®ì³ì˜µë‹ˆë‹¤. í…Œì¼ˆë¦¬-ë¦¬!" },
            { name: "ê´‘ì‹ ë„ ë¬´ë¦¬", power: 100, text: "ì£¼ë¬¸ì„ ì™¸ìš°ëŠ” ê´‘ì‹ ë„ë“¤ê³¼ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤." }
        ];

        let characters = [];
        let partyInventory = [];
        let day = 0;
        let selectedItemIndex = -1;

        // ==========================================
        // 1. ìºë¦­í„° ìƒì„± ë¡œì§ (MBTI & í¬ì¸íŠ¸ ë³µêµ¬)
        // ==========================================
        
        // í¬ì¸íŠ¸ ê²€ì¦
        function checkPoints() {
            const str = Number(document.getElementById('stat-str').value) || 0;
            const agi = Number(document.getElementById('stat-agi').value) || 0;
            const pow = Number(document.getElementById('stat-pow').value) || 0;
            const obs = Number(document.getElementById('stat-obs').value) || 0;

            const total = str + agi + pow + obs;
            const remain = MAX_POINTS - total;
            
            const remainEl = document.getElementById('remain-val');
            remainEl.innerText = remain;
            
            const errEl = document.getElementById('point-error');
            if(remain !== 0) {
                remainEl.style.color = "#ef5350";
                errEl.style.display = 'block';
            } else {
                remainEl.style.color = "var(--bright-accent)";
                errEl.style.display = 'none';
            }
            return remain;
        }

        // ìŠ¤íƒ¯ ê³„ì‚° (ê¸°ë³¸ 20 + ìœ ì € ë¶„ë°° + MBTI ë³´ë„ˆìŠ¤)
        function calculateAttributes(mbti, userStats) {
            let attr = {
                str: 20 + userStats.str,
                agi: 20 + userStats.agi,
                pow: 20 + userStats.pow,
                obs: 20 + userStats.obs
            };

            const chars = mbti.split('');
            // MBTI ë¡œì§ (ë³µêµ¬ë¨)
            // E: ê´€ì°°, I: íˆ¬ì§€(ë‚´ë©´)
            if(chars[0] === 'E') attr.obs += 10; else attr.pow += 10;
            // S: ê·¼ë ¥, N: íˆ¬ì§€(ì •ì‹ )
            if(chars[1] === 'S') attr.str += 10; else attr.pow += 10;
            // T: ê·¼ë ¥(ì „íˆ¬), F: ê´€ì°°(ê³µê°) -> ë°¸ëŸ°ìŠ¤ ì¡°ì •
            if(chars[2] === 'T') attr.str += 10; else attr.obs += 10;
            // J: ê·¼ë ¥(ì¤€ë¹„ì„±), P: ë¯¼ì²©(ìœ ì—°ì„±)
            if(chars[3] === 'J') attr.str += 10; else attr.agi += 10;

            return attr;
        }

        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            
            if(checkPoints() !== 0) return alert("ìŠ¤íƒ¯ í¬ì¸íŠ¸ë¥¼ ì •í™•íˆ 100ìœ¼ë¡œ ë§ì¶°ì£¼ì„¸ìš”.");
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const userStats = {
                str: Number(document.getElementById('stat-str').value),
                agi: Number(document.getElementById('stat-agi').value),
                pow: Number(document.getElementById('stat-pow').value),
                obs: Number(document.getElementById('stat-obs').value)
            };

            const finalAttr = calculateAttributes(mbti, userStats);

            characters.push({
                id: Date.now(),
                name: name,
                mbti: mbti,
                // ìƒì¡´ ìì› (ê·¸ë˜í”„ìš©)
                resources: { hp: 100, maxHp: 100, sanity: 100, maxSanity: 100, food: 100, maxFood: 100 },
                // ëŠ¥ë ¥ì¹˜ (ì´ë²¤íŠ¸ íŒì •ìš© - í…ìŠ¤íŠ¸ í‘œì‹œ)
                attr: finalAttr
            });

            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('input-name').value = '';
            document.getElementById('stat-str').value = 0;
            document.getElementById('stat-agi').value = 0;
            document.getElementById('stat-pow').value = 0;
            document.getElementById('stat-obs').value = 0;
            checkPoints();
            
            renderSetupList();
        }

        function renderSetupList() {
            const div = document.getElementById('setup-list');
            div.innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-header">
                        <span class="char-name">${c.name}</span> 
                        <span class="char-meta">${c.mbti}</span>
                    </div>
                    <div class="attr-box">
                        <span>ê·¼ë ¥: ${c.attr.str}</span>
                        <span>ë¯¼ì²©: ${c.attr.agi}</span>
                        <span>íˆ¬ì§€: ${c.attr.pow}</span>
                        <span>ê´€ì°°: ${c.attr.obs}</span>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // 2. ê²Œì„ ì—”ì§„
        // ==========================================
        function startGame() {
            if(characters.length < 1) return alert("ìµœì†Œ 1ëª…ì˜ íƒì‚¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'block';
            
            partyInventory.push(ITEMS[0]); 
            partyInventory.push(ITEMS[1]);
            
            addLog("ğŸ“¢ ì‹¬ì—°ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. í–‰ìš´ì„ ë¹•ë‹ˆë‹¤.");
            updateUI();
        }

        function stopGame() {
            if(!confirm("ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  ì´ˆê¸°í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            document.getElementById('page-sim').classList.remove('active');
            document.getElementById('page-setup').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'none';
        }

        function nextTurn() {
            day++;
            addLog(`<div style="margin: 20px 0 10px 0;"><span class="txt-day">Day ${day}</span> ì–´ë‘  ì†ì—ì„œ í•˜ë£¨ê°€ ì§€ë‚¬ìŠµë‹ˆë‹¤.</div>`);

            const survivors = characters.filter(c => c.resources.hp > 0);
            if(survivors.length === 0) {
                addLog("<div style='color:#ef5350; font-size:1.2em; margin-top:10px;'>ğŸ’€ ì „ë©¸. (Game Over)</div>");
                return;
            }

            // 1. í—ˆê¸° ì†Œëª¨
            survivors.forEach(c => {
                c.resources.food -= 15;
                if(c.resources.food < 0) {
                    c.resources.food = 0;
                    c.resources.hp -= 10;
                    addLog(`<span class="txt-info">.. ${c.name}: ê·¹ì‹¬í•œ í—ˆê¸°ë¡œ ì²´ë ¥ ê°ì†Œ (-10)</span>`);
                }
            });

            // 2. ì´ë²¤íŠ¸ íŒì •
            const roll = Math.random();
            if(roll < 0.35) processScavenge(survivors); // íŒŒë°
            else if(roll < 0.65) processThreat(survivors); // ìœ„í˜‘
            else processRest(survivors); // íœ´ì‹

            updateUI();
        }

        function processScavenge(survivors) {
            addLog(`<span style="color:#ffb74d;">[íƒìƒ‰]</span> ê²€ì€ íí—ˆë¥¼ ë’¤ì§‘ë‹ˆë‹¤...`);
            let found = false;
            
            survivors.forEach(c => {
                // ê´€ì°°(OBS) + ë¯¼ì²©(AGI) íŒì •
                const chance = c.attr.obs + (c.attr.agi * 0.5);
                if(Math.random() * 100 < chance) {
                    const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                    partyInventory.push({...item}); 
                    addLog(`.. ğŸ” <b>${c.name}</b>: [${item.name}] ë°œê²¬.`);
                    found = true;
                }
            });
            if(!found) addLog(`.. ì•„ë¬´ê²ƒë„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
        }

        function processThreat(survivors) {
            const threat = THREATS[Math.floor(Math.random() * THREATS.length)];
            addLog(`<span class="txt-threat">[ìœ„í˜‘] ${threat.text} (ë‚œì´ë„: ${threat.power})</span>`);
            
            // íŒŒí‹° ì „íˆ¬ë ¥ í•©ì‚°: ê·¼ë ¥(STR) + ë¯¼ì²©(AGI) + íˆ¬ì§€(POW)
            let teamPower = survivors.reduce((sum, c) => sum + c.attr.str + c.attr.agi + c.attr.pow, 0) / 1.5;
            teamPower += (Math.random() * 50); // ìš´
            
            if(teamPower >= threat.power) {
                addLog(`.. âœ… ì „ì›ì´ í˜ì„ í•©ì³ ìœ„í˜‘ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤!`);
                survivors.forEach(c => updateResource(c, 'sanity', -5));
            } else {
                addLog(`.. âŒ ë°©ì–´ ì‹¤íŒ¨! ë¬´ìë¹„í•œ ê³µê²©ì„ ë°›ìŠµë‹ˆë‹¤.`);
                const dmg = 20;
                survivors.forEach(c => {
                    updateResource(c, 'hp', -dmg);
                    updateResource(c, 'sanity', -10);
                    addLog(`.. ${c.name} (HP -${dmg}, SAN -10)`);
                });
            }
        }

        function processRest(survivors) {
            addLog(`<span style="color:#4fc3f7;">[íœ´ì‹]</span> ì ì‹œ ì•ˆì „í•œ ê³³ì—ì„œ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤.`);
            survivors.forEach(c => updateResource(c, 'sanity', 5));
        }

        // ==========================================
        // 3. ìì› ê´€ë¦¬ ë° ì•„ì´í…œ
        // ==========================================
        
        // ìì› ì•ˆì „ ì—…ë°ì´íŠ¸ (ìµœëŒ€ì¹˜ ì œí•œ, ê·¸ë˜í”„ ëš«ë¦¼ ë°©ì§€)
        function updateResource(char, type, amount) {
            if (char.resources.hp <= 0 && type !== 'hp') return;

            let current = char.resources[type];
            let maxKey = 'max' + type.charAt(0).toUpperCase() + type.slice(1);
            let max = char.resources[maxKey];
            
            char.resources[type] = Math.max(0, Math.min(max, current + amount));
        }

        function requestItemUse(idx) {
            selectedItemIndex = idx;
            const item = partyInventory[idx];
            
            const modal = document.getElementById('item-modal');
            document.getElementById('modal-title').innerText = `[${item.name}] ì‚¬ìš©`;
            document.getElementById('modal-desc').innerText = `${item.desc}\nëŒ€ìƒ ì„ íƒ:`;
            
            const listDiv = document.getElementById('modal-targets');
            listDiv.innerHTML = characters.map(c => {
                const isDead = c.resources.hp <= 0;
                return `<div class="target-btn ${isDead?'dead':''}" onclick="confirmUseItem(${c.id})">
                    ${c.name}<br>
                    <span style="font-size:0.8em; color:#90a4ae;">
                        HP:${c.resources.hp} SAN:${c.resources.sanity}
                    </span>
                </div>`;
            }).join('');
            
            modal.style.display = 'flex';
        }

        function confirmUseItem(charId) {
            if(selectedItemIndex === -1) return;
            const item = partyInventory[selectedItemIndex];
            const char = characters.find(c => c.id === charId);
            
            if(char) {
                updateResource(char, item.type, item.val);
                addLog(`<span class="txt-info">ğŸ’Š <b>${char.name}</b>ì—ê²Œ [${item.name}] ì‚¬ìš© ì™„ë£Œ.</span>`);
                partyInventory.splice(selectedItemIndex, 1);
            }
            closeModal(); updateUI();
        }

        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
            selectedItemIndex = -1;
        }

        // ==========================================
        // 4. UI ë Œë”ë§
        // ==========================================
        function updateUI() {
            const charDiv = document.getElementById('sim-char-list');
            
            charDiv.innerHTML = characters.map(c => {
                const isDead = c.resources.hp <= 0;
                // ê·¸ë˜í”„ 100% ì´ˆê³¼ ë°©ì§€
                const hpPct = Math.min(100, (c.resources.hp / c.resources.maxHp) * 100);
                const sanPct = Math.min(100, (c.resources.sanity / c.resources.maxSanity) * 100);
                const foodPct = Math.min(100, (c.resources.food / c.resources.maxFood) * 100);
                
                let classes = "char-card";
                if(c.resources.sanity < 30) classes += " madness";
                if(c.resources.hp < 30) classes += " danger";
                
                if(isDead) return `<div class="char-card" style="opacity:0.3; filter:grayscale(100%);"><div class="char-header"><span class="char-name" style="color:#b0bec5;">ğŸ’€ ${c.name} (ì‚¬ë§)</span></div></div>`;

                return `
                <div class="${classes}">
                    <div class="char-header">
                        <span class="char-name">${c.name}</span>
                        <span class="char-meta">${c.mbti}</span>
                    </div>
                    <div class="stat-row"><span>HP</span> <div class="bar-bg"><div class="bar-fill" style="width:${hpPct}%; background:var(--hp-color)"></div></div> <span>${c.resources.hp}</span></div>
                    <div class="stat-row"><span>SAN</span> <div class="bar-bg"><div class="bar-fill" style="width:${sanPct}%; background:var(--san-color)"></div></div> <span>${c.resources.sanity}</span></div>
                    <div class="stat-row"><span>FOOD</span> <div class="bar-bg"><div class="bar-fill" style="width:${foodPct}%; background:var(--food-color)"></div></div> <span>${c.resources.food}</span></div>
                    
                    <div class="attr-box">
                        <span>ê·¼ë ¥:${c.attr.str}</span> <span>ë¯¼ì²©:${c.attr.agi}</span>
                        <span>íˆ¬ì§€:${c.attr.pow}</span> <span>ê´€ì°°:${c.attr.obs}</span>
                    </div>
                </div>
                `;
            }).join('');

            const invDiv = document.getElementById('shared-inv');
            if(partyInventory.length === 0) {
                invDiv.innerHTML = `<span style="color:#546e7a; padding:10px; font-size:0.9em;">ë¹„ì–´ìˆìŒ</span>`;
            } else {
                invDiv.innerHTML = partyInventory.map((item, idx) => `
                    <button class="item-btn" onclick="requestItemUse(${idx})" title="${item.desc}">${item.name}</button>
                `).join('');
            }
            const logWin = document.getElementById('log-window'); logWin.scrollTop = logWin.scrollHeight;
        }

        function addLog(html) {
            const win = document.getElementById('log-window');
            const div = document.createElement('div'); div.className = 'log-entry'; div.innerHTML = html;
            win.appendChild(div);
        }

        // ì´ˆê¸° ì‹¤í–‰
        checkPoints();
    </script>
</body>
</html>
