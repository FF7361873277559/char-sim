<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Abyss Survivors: Deep Green</title>
    <style>
        /* 1. ì‹¬ì—° í…Œë§ˆ (Abyssal Dark Green) */
        :root {
            /* ìˆœìˆ˜ ê²€ì •(#000) ì‚¬ìš© ì§€ì–‘ -> ê¹Šì€ ëŠªìƒ‰/ë¨¹ìƒ‰ ì‚¬ìš© */
            --bg-color: #0d1110;       /* ì•„ì£¼ ì–´ë‘ìš´ ë…¹íšŒìƒ‰ */
            --container-bg: #141815;   /* ì–´ë‘ìš´ ì»¨í…Œì´ë„ˆ */
            --panel-bg: #1b211d;       /* íŒ¨ë„ ë°°ê²½ */
            
            --main-accent: #2e7d32;    /* ë©”ì¸ í¬ì¸íŠ¸ (ì§„í•œ ë…¹ìƒ‰) */
            --sub-accent: #69f0ae;     /* í•˜ì´ë¼ì´íŠ¸ (ë„¤ì˜¨ ë¯¼íŠ¸) */
            
            --text-main: #e0e2e1;
            --text-sub: #8a9990;
            
            --hp-color: #b71c1c;       /* í”¼ (ì–´ë‘ìš´ ë¹¨ê°•) */
            --san-color: #4a148c;      /* ê´‘ê¸° (ì–´ë‘ìš´ ë³´ë¼) */
            --food-color: #f57f17;     /* í—ˆê¸° (ì–´ë‘ìš´ ë…¸ë‘) */
            
            --btn-bg: #263238;
            --btn-hover: #37474f;
            
            --border-color: #2c3830;
        }

        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }

        /* ë ˆì´ì•„ì›ƒ */
        .container { 
            max-width: 1400px; margin: 0 auto; 
            background: var(--container-bg); 
            height: 100%; border-radius: 6px; border: 1px solid var(--border-color); 
            display: flex; flex-direction: column;
            box-shadow: 0 0 40px rgba(0, 20, 10, 0.5); /* ë…¹ìƒ‰ í‹´íŠ¸ ê·¸ë¦¼ì */
        }

        .header { 
            padding: 15px 25px; border-bottom: 1px solid var(--border-color); 
            flex-shrink: 0; display:flex; justify-content:space-between; align-items:center;
            background: linear-gradient(90deg, #141815, #0f2015);
        }
        h1 { margin: 0; color: var(--sub-accent); font-size: 1.5em; text-shadow: 0 0 10px rgba(105, 240, 174, 0.3); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; animation: fadeIn 0.8s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* 2ë‹¨ ë ˆì´ì•„ì›ƒ */
        #page-sim.active { display: flex; gap: 20px; padding: 20px; overflow: hidden; }

        .sim-left { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .sim-right { 
            flex: 1; display: flex; flex-direction: column; overflow-y: auto; 
            min-width: 360px; gap: 20px; 
            padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°” ì—¬ë°± */
        }

        /* ë¡œê·¸ ì°½ */
        #log-window { 
            flex-grow: 1; overflow-y: auto; 
            background: #111412; /* ì•„ì£¼ ì–´ë‘ìš´ ë…¹ìƒ‰ */
            border: 1px solid var(--border-color); 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 0.95em; 
            border-radius: 4px; color: #cfd8dc;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #1f2923; padding-bottom: 6px; line-height: 1.6; }
        .txt-day { color: var(--sub-accent); font-weight: bold; border: 1px solid var(--main-accent); padding: 2px 8px; border-radius: 4px; font-size: 0.8em;}
        .txt-threat { color: #ef5350; }
        .txt-item { color: #fdd835; }
        .txt-info { color: #81d4fa; }

        /* ê³µìš© ì¸ë²¤í† ë¦¬ */
        .inventory-box {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            padding: 15px; border-radius: 4px;
        }
        .inv-title { font-weight: bold; color: var(--sub-accent); margin-bottom: 12px; display:block; border-bottom:1px solid var(--border-color); padding-bottom:5px;}
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .item-btn { 
            background: var(--btn-bg); color: #b0bec5; border: 1px solid #455a64;
            padding: 6px 12px; font-size: 0.85em; cursor: pointer; border-radius: 2px;
            transition: all 0.2s;
        }
        .item-btn:hover { background: var(--main-accent); border-color: var(--sub-accent); color: white; box-shadow: 0 0 8px var(--main-accent); }

        /* ìºë¦­í„° ì¹´ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .char-card { 
            background: var(--panel-bg); border: 1px solid var(--border-color); padding: 15px; 
            border-left: 3px solid #444; border-radius: 4px;
            position: relative;
        }
        /* ìƒíƒœë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ */
        .char-card.danger { border-left-color: var(--hp-color); box-shadow: inset 10px 0 20px -10px rgba(183, 28, 28, 0.2); }
        .char-card.madness { border-left-color: var(--san-color); box-shadow: inset 10px 0 20px -10px rgba(74, 20, 140, 0.2); }

        .char-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-end; }
        .char-name { font-weight: bold; font-size: 1.1em; color: #fff; }
        .char-meta { font-size: 0.8em; color: var(--text-sub); }

        /* ê·¸ë˜í”„ ë°” ìŠ¤íƒ€ì¼ */
        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #aaa; margin-top: 6px; }
        .bar-bg { 
            flex-grow: 1; background: #263238; height: 6px; margin: 0 10px; 
            border-radius: 2px; overflow: hidden; /* â˜…ì¤‘ìš”: ê·¸ë˜í”„ ëš«ë¦¼ ë°©ì§€ */
        }
        .bar-fill { height: 100%; transition: width 0.4s ease-out; max-width: 100%; /* â˜…ì¤‘ìš”: 100% ì´ˆê³¼ ë°©ì§€ */ }

        /* ëª¨ë‹¬ì°½ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 15, 12, 0.85); z-index: 1000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .modal-box {
            background: #1c241c; border: 1px solid var(--sub-accent); padding: 25px;
            width: 420px; max-width: 90%; border-radius: 6px; 
            box-shadow: 0 0 30px rgba(46, 125, 50, 0.3);
            text-align: center;
        }
        .modal-title { color: var(--sub-accent); font-size: 1.3em; margin-bottom: 10px; font-weight: bold; }
        .modal-desc { color: #ccc; margin-bottom: 25px; font-size: 0.95em; line-height: 1.5; }
        .target-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        
        .target-btn {
            background: #253028; border: 1px solid #3d5afe; color: #e0e0e0; padding: 12px; cursor: pointer;
            border-radius: 4px; transition: 0.2s;
        }
        .target-btn:hover { background: #1b5e20; border-color: var(--sub-accent); color: white; }
        .target-btn.dead { opacity: 0.4; pointer-events: none; text-decoration: line-through; border-color: #444; }

        .modal-close { background: transparent; border: 1px solid #ef5350; color: #ef5350; padding: 8px 25px; cursor: pointer; border-radius: 4px; }
        .modal-close:hover { background: #c62828; color: white; border-color: #c62828; }

        /* ë²„íŠ¼ */
        .btn-main { 
            background: #1b5e20; color: white; border: none; padding: 12px 20px; 
            font-weight: bold; cursor: pointer; font-size: 1em; width: 100%; margin-bottom: 10px; 
            border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2e7d32;
        }
        .btn-main:hover { background: #2e7d32; box-shadow: 0 0 10px rgba(46, 125, 50, 0.5); }
        .btn-sub { background: #37474f; color: #cfd8dc; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }

        /* ì…ë ¥ í¼ */
        .input-section { background: rgba(30, 40, 35, 0.5); padding: 20px; border:1px solid var(--border-color); border-radius: 4px;}
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { 
            width: 100%; padding: 12px; background: #111412; 
            border: 1px solid #455a64; color: white; border-radius: 2px;
        }
        input:focus, select:focus { border-color: var(--sub-accent); outline: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ Abyss Survivors</h1>
            <div id="setup-btn-group" style="display:none;">
                <button class="btn-sub" onclick="stopGame()">âš™ï¸ ì¢…ë£Œ</button>
            </div>
        </div>

        <div id="page-setup" class="page active">
            <div style="max-width: 800px; margin: 0 auto;">
                <p style="color:#8a9990; margin-bottom: 20px;">ì‹¬ì—°ì—ì„œ ì‚´ì•„ë‚¨ì„ íƒì‚¬ìë¥¼ ë“±ë¡í•˜ì‹­ì‹œì˜¤.</p>
                
                <div class="input-section">
                    <div class="input-group">
                        <input type="text" id="input-name" placeholder="íƒì‚¬ì ì´ë¦„ (Ex. K)">
                        <select id="input-mbti">
                            <option value="INTJ">INTJ (ëƒ‰ì² í•œ ì „ëµê°€)</option>
                            <option value="INTP">INTP (ì‹¬ì—°ì˜ ì—°êµ¬ê°€)</option>
                            <option value="INFJ">INFJ (ê³ ë‡Œí•˜ëŠ” ì˜ˆì–¸ì)</option>
                            <option value="ISTP">ISTP (ëƒ‰ì†Œì ì¸ í•´ê²°ì‚¬)</option>
                            <option value="ESTJ">ESTJ (ê°•ì••ì ì¸ ì§€íœ˜ê´€)</option>
                            <option value="ESTP">ESTP (ë¬´ëª¨í•œ ëª¨í—˜ê°€)</option>
                            <option value="ENFJ">ENFJ (ê´‘ê¸°ì˜ ì„ ë™ê°€)</option>
                            <option value="ENTP">ENTP (ë¯¸ì¹˜ê´‘ì´ ë°œëª…ê°€)</option>
                            <option value="ISFP">ISFP (ì¡°ìš©í•œ ê´€ì°°ì)</option>
                        </select>
                    </div>
                    <button class="btn-main" onclick="addCharacter()">íƒì‚¬ì ëª…ë‹¨ ì¶”ê°€</button>
                </div>

                <div id="setup-list" class="char-grid"></div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn-main" style="padding: 15px 30px; font-size: 1.2em; width:auto;" onclick="startGame()">ğŸ² ì‹¬ì—°ìœ¼ë¡œ ì§„ì… (Start Session)</button>
                </div>
            </div>
        </div>

        <div id="page-sim" class="page">
            
            <div class="sim-left">
                <button class="btn-main" onclick="nextTurn()">ğŸŒ™ ë‹¤ìŒ ë‚  (Next Day)</button>
                <div id="log-window">
                    <div class="log-entry" style="color:#555;">...ê¸°ë¡ ì‹œìŠ¤í…œ ê°€ë™...</div>
                </div>
            </div>

            <div class="sim-right">
                <div class="inventory-box">
                    <span class="inv-title">ğŸ“¦ ê³µìš© ë¬¼ì (Shared Supply)</span>
                    <div id="shared-inv" class="inv-grid">
                        <span style="color:#555; font-size:0.9em; padding:10px;">..ë¬¼ìê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤..</span>
                    </div>
                </div>

                <div id="sim-char-list" class="char-grid"></div>
            </div>
        </div>
    </div>

    <div id="item-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="modal-title" class="modal-title">ì•„ì´í…œ ì‚¬ìš©</div>
            <div id="modal-desc" class="modal-desc">ëŒ€ìƒ ì„ íƒ</div>
            <div id="modal-targets" class="target-list"></div>
            <button class="modal-close" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 0. ë°ì´í„° ë° ìƒìˆ˜
        // ==========================================
        const MAX_STAT_CAP = 100; // ì ˆëŒ€ì ì¸ ìµœëŒ€ì¹˜ ê¸°ì¤€ (í•„ìš”ì‹œ ë³€ê²½ ê°€ëŠ¥)
        
        const ITEMS = [
            { name: "ì‘ê¸‰ í‚¤íŠ¸", type: "hp", val: 30, desc: "ì°¢ì–´ì§„ ì‚´ì„ ë´‰í•©í•©ë‹ˆë‹¤. (HP +30)" },
            { name: "ë…¹ìŠ¨ í†µì¡°ë¦¼", type: "food", val: 40, desc: "ë¹„ë¦¿í•˜ì§€ë§Œ ë°°ëŠ” ì±„ì›ë‹ˆë‹¤. (ì‹ëŸ‰ +40)" },
            { name: "ì§„ì •ì œ", type: "sanity", val: 20, desc: "ë–¨ë¦¬ëŠ” ì†ì„ ë©ˆì¶¥ë‹ˆë‹¤. (ì´ì„± +20)" },
            { name: "ì •í™”ìˆ˜", type: "food", val: 25, desc: "ì˜¤ì—¼ë˜ì§€ ì•Šì€ ë¬¼ì…ë‹ˆë‹¤. (ì‹ëŸ‰ +25)" },
            { name: "ì—˜ë” ì‚¬ì¸", type: "sanity", val: 40, desc: "ê³ ëŒ€ í‘œì‹ì´ ë§ˆìŒì„ ë³´í˜¸í•©ë‹ˆë‹¤. (ì´ì„± +40)" },
            { name: "êµ°ìš© ìŠ¤íŒ€íŒ©", type: "hp", val: 15, desc: "ê³ í†µì„ ì ì‹œ ìŠê²Œ í•©ë‹ˆë‹¤. (HP +15)" }
        ];

        const THREATS = [
            { name: "ë¹„ìœ í´ë¦¬ë“œ ë¯¸ë¡œ", power: 70, text: "ê³µê°„ì´ ë’¤í‹€ë ¤ ì¶œêµ¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." },
            { name: "ì‹¬í•´ì¸(Deep One)", power: 110, text: "ì¶•ì¶•í•œ ë¹„ëŠ˜ì„ ê°€ì§„ ê´´ë¬¼ë“¤ì´ ìŠµê²©í•©ë‹ˆë‹¤." },
            { name: "ê²€ì€ ì•ˆê°œ", power: 90, text: "ì•ˆê°œ ì†ì—ì„œ ì†ì‚­ì„ì´ ë“¤ë ¤ì™€ ì •ì‹ ì„ ê°‰ì•„ë¨¹ìŠµë‹ˆë‹¤." },
            { name: "ì‡¼ê³ ìŠ¤", power: 140, text: "í˜•ì²´ ì—†ëŠ” ì ì•¡ì§ˆ ê´´ë¬¼ì´ ë®ì³ì˜µë‹ˆë‹¤. í…Œì¼ˆë¦¬-ë¦¬!" },
            { name: "ê´‘ì‹ ë„ ë¬´ë¦¬", power: 80, text: "ì£¼ë¬¸ì„ ì™¸ìš°ëŠ” ê´‘ì‹ ë„ë“¤ê³¼ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤." }
        ];

        let characters = [];
        let partyInventory = [];
        let day = 0;
        let selectedItemIndex = -1;

        // ==========================================
        // 1. ìºë¦­í„° ìƒì„± ë° ê´€ë¦¬
        // ==========================================
        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            let stats = {
                hp: 100, maxHp: 100,
                sanity: 100, maxSanity: 100,
                food: 100, maxFood: 100,
                power: 20 + Math.floor(Math.random()*30), // ì „íˆ¬ë ¥
                obs: 20 + Math.floor(Math.random()*30)    // ê´€ì°°ë ¥
            };

            // MBTI ë³´ë„ˆìŠ¤
            if(mbti.includes('T')) stats.power += 20; // ì‚¬ê³ í˜•: ì „íˆ¬ë ¥
            if(mbti.includes('N')) stats.obs += 20;   // ì§ê´€í˜•: ê´€ì°°ë ¥

            characters.push({
                id: Date.now(),
                name: name,
                mbti: mbti,
                stats: stats,
                relations: {}
            });

            document.getElementById('input-name').value = '';
            renderSetupList();
        }

        function renderSetupList() {
            const div = document.getElementById('setup-list');
            div.innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-header">
                        <span class="char-name">${c.name}</span> 
                        <span class="char-meta">${c.mbti}</span>
                    </div>
                    <div class="char-meta">ì „íˆ¬ë ¥: ${c.stats.power} / ê´€ì°°ë ¥: ${c.stats.obs}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // 2. ê²Œì„ ì—”ì§„
        // ==========================================
        function startGame() {
            if(characters.length < 1) return alert("ìµœì†Œ 1ëª…ì˜ íƒì‚¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'block';
            
            // ì´ˆê¸° ë³´ê¸‰í’ˆ
            partyInventory.push(ITEMS[0]); 
            partyInventory.push(ITEMS[1]);
            
            addLog("ğŸ“¢ ì‹¬ì—°ì— ì§„ì…í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœëŠ” ì–‘í˜¸í•©ë‹ˆë‹¤.");
            updateUI();
        }

        function stopGame() {
            if(!confirm("ì„¸ì…˜ì„ ì¢…ë£Œí•˜ê³  ì´ˆê¸°í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            document.getElementById('page-sim').classList.remove('active');
            document.getElementById('page-setup').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'none';
        }

        function nextTurn() {
            day++;
            addLog(`<div style="margin: 20px 0 10px 0;"><span class="txt-day">Day ${day}</span> ì–´ë‘  ì†ì—ì„œ í•˜ë£¨ê°€ ì§€ë‚¬ìŠµë‹ˆë‹¤.</div>`);

            const survivors = characters.filter(c => c.stats.hp > 0);
            if(survivors.length === 0) {
                addLog("<div style='color:#ef5350; font-size:1.2em; margin-top:10px;'>ğŸ’€ ëª¨ë“  íƒì‚¬ìê°€ ì‹¬ì—°ì— ì ì‹ë˜ì—ˆìŠµë‹ˆë‹¤. (Game Over)</div>");
                return;
            }

            // 1. ìì› ì†Œëª¨
            survivors.forEach(c => {
                c.stats.food -= 15;
                if(c.stats.food < 0) {
                    c.stats.food = 0;
                    c.stats.hp -= 10;
                    addLog(`<span class="txt-info">.. ${c.name}: ê·¹ì‹¬í•œ í—ˆê¸°ë¡œ ì²´ë ¥ ê°ì†Œ (-10)</span>`);
                }
            });

            // 2. ì´ë²¤íŠ¸ íŒì •
            const roll = Math.random();
            if(roll < 0.35) processScavenge(survivors); // íŒŒë° (35%)
            else if(roll < 0.65) processThreat(survivors); // ìœ„í˜‘ (30%)
            else processRest(survivors); // íœ´ì‹/ìƒí˜¸ì‘ìš© (35%)

            updateUI();
        }

        function processScavenge(survivors) {
            addLog(`<span style="color:#fdd835;">[íƒìƒ‰]</span> ê²€ì€ íí—ˆë¥¼ ë’¤ì§‘ë‹ˆë‹¤...`);
            let found = false;
            
            survivors.forEach(c => {
                // ê´€ì°°ë ¥ + ìš´ íŒì •
                if(Math.random() * 100 < c.stats.obs + 15) {
                    const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                    partyInventory.push({...item}); 
                    addLog(`.. ğŸ” <b>${c.name}</b>: [${item.name}] ë°œê²¬.`);
                    found = true;
                }
            });
            if(!found) addLog(`.. ë¨¼ì§€ì™€ ì¬ ë§ê³ ëŠ” ì•„ë¬´ê²ƒë„ ì—†ìŠµë‹ˆë‹¤.`);
        }

        function processThreat(survivors) {
            const threat = THREATS[Math.floor(Math.random() * THREATS.length)];
            addLog(`<span class="txt-threat">[ìœ„í˜‘] ${threat.text} (ë‚œì´ë„: ${threat.power})</span>`);
            
            // íŒŒí‹° ì „íˆ¬ë ¥ í•©ì‚°
            let teamPower = survivors.reduce((sum, c) => sum + c.stats.power, 0) + (Math.random() * 50);
            
            if(teamPower >= threat.power) {
                addLog(`.. âœ… ì „ì›ì´ í˜ì„ í•©ì³ ìœ„í˜‘ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤!`);
                // ì„±ê³µí•´ë„ ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ë°›ìŒ
                survivors.forEach(c => updateStat(c, 'sanity', -5));
            } else {
                addLog(`.. âŒ ë°©ì–´ ì‹¤íŒ¨! ë¬´ìë¹„í•œ ê³µê²©ì„ ë°›ìŠµë‹ˆë‹¤.`);
                const dmg = 20;
                survivors.forEach(c => {
                    updateStat(c, 'hp', -dmg);
                    updateStat(c, 'sanity', -10);
                    addLog(`.. ${c.name} (HP -${dmg}, SAN -10)`);
                });
            }
        }

        function processRest(survivors) {
            addLog(`<span style="color:#81d4fa;">[íœ´ì‹]</span> ì ì‹œ ì•ˆì „í•œ ê³³ì—ì„œ ìˆ¨ì„ ê³ ë¦…ë‹ˆë‹¤.`);
            survivors.forEach(c => {
                updateStat(c, 'sanity', 5); // ì†ŒëŸ‰ íšŒë³µ
            });
        }

        // ==========================================
        // 3. ì•„ì´í…œ ì‚¬ìš© (ìµœëŒ€ì¹˜ ì œí•œ ë¡œì§ ì ìš©)
        // ==========================================
        
        // ìŠ¤íƒ¯ ì•ˆì „ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í•µì‹¬ ë¡œì§)
        function updateStat(char, type, amount) {
            if (char.stats.hp <= 0 && type !== 'hp') return; // ì£½ì€ ìëŠ” ë§ì´ ì—†ë‹¤ (ë‹¨, ë¶€í™œ ë¡œì§ ìˆë‹¤ë©´ ì˜ˆì™¸)

            // í˜„ì¬ ìˆ˜ì¹˜ + ë³€ë™ëŸ‰
            let newVal = char.stats[type] + amount;
            
            // ìµœëŒ€ì¹˜ ê¸°ì¤€ ê²°ì • (maxHp, maxSanity ë“±)
            let maxKey = 'max' + type.charAt(0).toUpperCase() + type.slice(1);
            let maxVal = char.stats[maxKey] || 100; // ê¸°ë³¸ 100

            // â˜… ì¤‘ìš”: ìµœëŒ€ê°’(maxVal)ì„ ë„˜ì§€ ì•Šê²Œ Math.min ì²˜ë¦¬
            // â˜… ì¤‘ìš”: 0 ë°‘ìœ¼ë¡œ ë‚´ë ¤ê°€ì§€ ì•Šê²Œ Math.max ì²˜ë¦¬
            char.stats[type] = Math.max(0, Math.min(maxVal, newVal));
        }

        function requestItemUse(idx) {
            selectedItemIndex = idx;
            const item = partyInventory[idx];
            
            const modal = document.getElementById('item-modal');
            document.getElementById('modal-title').innerText = `[${item.name}] ì‚¬ìš©`;
            document.getElementById('modal-desc').innerText = `${item.desc}\n\nëˆ„êµ¬ì—ê²Œ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            const listDiv = document.getElementById('modal-targets');
            listDiv.innerHTML = characters.map(c => {
                const isDead = c.stats.hp <= 0;
                return `<div class="target-btn ${isDead?'dead':''}" onclick="confirmUseItem(${c.id})">
                    ${c.name} <br>
                    <span style="font-size:0.8em; color:#aaa;">
                        HP:${c.stats.hp}/${c.stats.maxHp} SAN:${c.stats.sanity}/${c.stats.maxSanity}
                    </span>
                </div>`;
            }).join('');
            
            modal.style.display = 'flex';
        }

        function confirmUseItem(charId) {
            if(selectedItemIndex === -1) return;
            
            const item = partyInventory[selectedItemIndex];
            const char = characters.find(c => c.id === charId);
            
            if(char) {
                // ì•ˆì „í•œ ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
                updateStat(char, item.type, item.val);
                addLog(`<span class="txt-info">ğŸ’Š <b>${char.name}</b>ì—ê²Œ [${item.name}] ì‚¬ìš© ì™„ë£Œ.</span>`);
                
                // ì•„ì´í…œ ì†Œëª¨
                partyInventory.splice(selectedItemIndex, 1);
            }
            
            closeModal();
            updateUI();
        }

        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
            selectedItemIndex = -1;
        }

        // ==========================================
        // 4. UI ë Œë”ë§ (ê·¸ë˜í”„ ëš«ë¦¼ ë°©ì§€ ì ìš©)
        // ==========================================
        function updateUI() {
            const charDiv = document.getElementById('sim-char-list');
            
            charDiv.innerHTML = characters.map(c => {
                const isDead = c.stats.hp <= 0;
                
                // â˜… ì¤‘ìš”: ê·¸ë˜í”„ ê³„ì‚° ì‹œ 100% ì´ˆê³¼ ë°©ì§€ (Math.min(100, ...))
                const hpPct = Math.min(100, (c.stats.hp / c.stats.maxHp) * 100);
                const sanPct = Math.min(100, (c.stats.sanity / c.stats.maxSanity) * 100);
                const foodPct = Math.min(100, (c.stats.food / c.stats.maxFood) * 100);
                
                let classes = "char-card";
                if(c.stats.sanity < 30) classes += " madness";
                if(c.stats.hp < 30) classes += " danger";
                
                if(isDead) return `<div class="char-card" style="opacity:0.3; filter:grayscale(100%); border-color:#333;"><div class="char-header"><span class="char-name">ğŸ’€ ${c.name} (ì‚¬ë§)</span></div></div>`;

                return `
                <div class="${classes}">
                    <div class="char-header">
                        <span class="char-name">${c.name}</span>
                        <span class="char-meta">${c.mbti}</span>
                    </div>
                    
                    <div class="stat-row">
                        <span>HP</span> 
                        <div class="bar-bg"><div class="bar-fill" style="width:${hpPct}%; background:var(--hp-color)"></div></div> 
                        <span>${c.stats.hp}</span>
                    </div>
                    <div class="stat-row">
                        <span>SAN</span> 
                        <div class="bar-bg"><div class="bar-fill" style="width:${sanPct}%; background:var(--san-color)"></div></div> 
                        <span>${c.stats.sanity}</span>
                    </div>
                    <div class="stat-row">
                        <span>FOOD</span> 
                        <div class="bar-bg"><div class="bar-fill" style="width:${foodPct}%; background:var(--food-color)"></div></div> 
                        <span>${c.stats.food}</span>
                    </div>
                </div>
                `;
            }).join('');

            // ì¸ë²¤í† ë¦¬ ë Œë”ë§
            const invDiv = document.getElementById('shared-inv');
            if(partyInventory.length === 0) {
                invDiv.innerHTML = `<span style="color:#555; font-size:0.9em; padding:10px;">..ë¬¼ìê°€ ë°”ë‹¥ë‚¬ìŠµë‹ˆë‹¤..</span>`;
            } else {
                invDiv.innerHTML = partyInventory.map((item, idx) => `
                    <button class="item-btn" onclick="requestItemUse(${idx})" title="${item.desc}">
                        ${item.name}
                    </button>
                `).join('');
            }

            const logWin = document.getElementById('log-window');
            logWin.scrollTop = logWin.scrollHeight;
        }

        function addLog(html) {
            const win = document.getElementById('log-window');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = html;
            win.appendChild(div);
        }
    </script>
</body>
</html>
