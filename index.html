<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¬ì—°ì˜ ìƒì¡´ìë“¤ (Abyss Survivors)</title>
    <style>
        /* 1. ë””ìì¸: CoC & Dark Fantasy Style */
        :root {
            --bg-color: #0a0a0c;
            --container-bg: #141417;
            --card-bg: #1e1e24;
            --text-main: #d1d1e0;
            --text-sub: #7a7a8c;
            
            --hp-color: #d32f2f;       /* ì²´ë ¥: í•ë¹› */
            --san-color: #7b1fa2;      /* ì´ì„±: ë³´ë¼ìƒ‰ (ê´‘ê¸°) */
            --food-color: #fbc02d;     /* í¬ë§Œ: ë…¸ë‘ */
            
            --btn-item: #2c3e50;
            --btn-hover: #34495e;
            
            --log-bg: #000000;
            --log-text: #bdc3c7;
        }

        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            line-height: 1.6;
        }

        h1 { color: #9b59b6; text-shadow: 0 0 10px rgba(155, 89, 182, 0.5); border-bottom: 1px solid #333; padding-bottom: 15px; }
        h2, h3 { color: #ecf0f1; }

        .container { max-width: 1000px; margin: 0 auto; background: var(--container-bg); padding: 25px; border-radius: 4px; border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.6s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ì…ë ¥ í¼ */
        .input-section { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 4px; border: 1px solid #333; margin-bottom: 20px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-box { flex: 1; }
        label { display: block; font-size: 0.8em; color: var(--text-sub); margin-bottom: 5px; }
        input, select { 
            width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; 
            border-radius: 2px; box-sizing: border-box; 
        }

        /* ìŠ¤íƒ¯ ì…ë ¥ */
        .stat-dist-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .stat-input-group input { text-align: center; color: #64b5f6; font-weight: bold; }
        
        /* ë²„íŠ¼ */
        button { padding: 10px 20px; border: none; border-radius: 2px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #5e35b1, #4527a0); width: 100%; box-shadow: 0 4px 15px rgba(94, 53, 177, 0.4); }
        .btn-primary:hover { filter: brightness(1.2); }
        .btn-secondary { background: #424242; }
        
        /* ì•„ì´í…œ ë²„íŠ¼ */
        .item-btn { 
            background: var(--btn-item); color: #ccc; font-size: 0.75em; padding: 4px 8px; margin: 2px; 
            border: 1px solid #444; cursor: pointer; display: inline-block; 
        }
        .item-btn:hover { background: var(--btn-hover); color: white; border-color: #aaa; }

        /* ìºë¦­í„° ì¹´ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; margin-top: 20px; }
        .char-card { 
            background: var(--card-bg); border: 1px solid #333; padding: 15px; 
            position: relative; border-left: 3px solid #555; 
        }
        .char-card.danger { border-left-color: var(--hp-color); } /* ìœ„ê¸‰ */
        .char-card.madness { border-left-color: var(--san-color); } /* ê´‘ê¸° */

        .char-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .char-name { font-size: 1.1em; font-weight: bold; color: #fff; }
        .char-class { font-size: 0.8em; color: #888; }

        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #aaa; margin-top: 5px; }
        .bar-bg { flex-grow: 1; background: #333; height: 5px; margin: 0 10px; position: relative; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        
        .inv-area { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #444; }
        .inv-label { font-size: 0.75em; color: #666; display: block; margin-bottom: 5px; }

        /* ë¡œê·¸ ì°½ */
        #log-window { 
            height: 500px; overflow-y: auto; background: var(--log-bg); border: 1px solid #333; 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 0.9em; 
        }
        .log-entry { margin-bottom: 10px; border-bottom: 1px solid #1a1a1a; padding-bottom: 5px; }
        
        /* í…ìŠ¤íŠ¸ ì»¬ëŸ¬ */
        .txt-day { color: #fff; background: #333; padding: 2px 6px; font-size: 0.8em; }
        .txt-threat { color: #ff5252; text-shadow: 0 0 5px rgba(255, 82, 82, 0.5); }
        .txt-sanity { color: #e040fb; }
        .txt-item { color: #fdd835; }
        .txt-sys { color: #7f8c8d; font-style: italic; }

    </style>
</head>
<body>

    <div class="container">
        <div id="page-setup" class="page active">
            <h1>ğŸ‘ï¸ Abyss Survivors (ì‹¬ì—°ì˜ ìƒì¡´ìë“¤)</h1>
            <p style="color:#aaa; font-size:0.9em;">
                "ë³„ë“¤ì´ ì œ ìë¦¬ë¥¼ ì°¾ì„ ë•Œ, ì¸ë¥˜ì˜ ì‹œëŒ€ëŠ” ëë‚¬ë‹¤."<br>
                SANì¹˜(ì´ì„±)ì™€ ì²´ë ¥ì„ ê´€ë¦¬í•˜ë©°, ë‹¤ê°€ì˜¤ëŠ” 'ê·¸ê²ƒ'ë“¤ë¡œë¶€í„° ìƒì¡´í•˜ì‹­ì‹œì˜¤.
            </p>
            
            <div class="input-section">
                <div class="input-group">
                    <div class="input-box">
                        <label>íƒì‚¬ì ì´ë¦„ (Investigator)</label>
                        <input type="text" id="input-name" placeholder="ì˜ˆ: í‚¤ë¦¬ì‹œë§ˆ (ì‚¬ë¦½íƒì •)">
                    </div>
                    <div class="input-box">
                        <label>ì„±í–¥ (MBTI)</label>
                        <select id="input-mbti">
                            <option value="INTJ">INTJ (ëƒ‰ì² í•œ ì „ëµê°€)</option>
                            <option value="INTP">INTP (ì˜¤ì»¬íŠ¸ ì—°êµ¬ê°€)</option>
                            <option value="INFJ">INFJ (ê³ ë‡Œí•˜ëŠ” ì˜ˆì–¸ì)</option>
                            <option value="INFP">INFP (ê¿ˆê¾¸ëŠ” ëª½ìƒê°€)</option>
                            <option value="ISTJ">ISTJ (ê·œì¹™ì ì¸ ê´€ë¦¬ì)</option>
                            <option value="ISTP">ISTP (ëƒ‰ì†Œì ì¸ í•´ê²°ì‚¬)</option>
                            <option value="ISFJ">ISFJ (í—Œì‹ ì ì¸ ì¡°ë ¥ì)</option>
                            <option value="ISFP">ISFP (ë°©ë‘í•˜ëŠ” ì˜ˆìˆ ê°€)</option>
                            <option value="ENTJ">ENTJ (ì˜¤ë§Œí•œ ì§€ë°°ì)</option>
                            <option value="ENTP">ENTP (ê´‘ê¸°ì–´ë¦° ë°œëª…ê°€)</option>
                            <option value="ENFJ">ENFJ (í˜„í˜¹í•˜ëŠ” ì„ ë™ê°€)</option>
                            <option value="ENFP">ENFP (ëª…ë‘í•œ ë¶„ìœ„ê¸°ë©”ì´ì»¤)</option>
                            <option value="ESTJ">ESTJ (ê°•ì••ì ì¸ ë¦¬ë”)</option>
                            <option value="ESTP">ESTP (ë¬´ëª¨í•œ ëª¨í—˜ê°€)</option>
                            <option value="ESFJ">ESFJ (ì¹œì ˆí•œ ì´ì›ƒ)</option>
                            <option value="ESFP">ESFP (ì¾Œë½ì£¼ì˜ì)</option>
                        </select>
                    </div>
                </div>

                <div class="remain-point" style="text-align:right; font-size:0.85em; margin-bottom:5px;">
                    ì”ì—¬ í¬ì¸íŠ¸: <span id="remain-val" style="color:#64b5f6; font-size:1.2em;">100</span>
                </div>
                <div class="stat-dist-box">
                    <div class="stat-input-group">
                        <label>ê·¼ë ¥ (STR)<br><span style="color:#555">ë¬¼ë¦¬ ì „íˆ¬</span></label>
                        <input type="number" id="stat-str" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>ë¯¼ì²© (DEX)<br><span style="color:#555">íšŒí”¼/ë„ì£¼</span></label>
                        <input type="number" id="stat-agi" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>íˆ¬ì§€ (POW)<br><span style="color:#555">ì •ì‹  ì €í•­</span></label>
                        <input type="number" id="stat-agg" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>ê´€ì°° (OBS)<br><span style="color:#555">íŒŒë°/ë°œê²¬</span></label>
                        <input type="number" id="stat-act" value="0" min="0" oninput="checkPoints()">
                    </div>
                </div>
                <div id="point-error" style="color:#ff5252; display:none; text-align:right; font-size:0.8em; margin-top:5px;">
                    âš  í¬ì¸íŠ¸ í•©ê³„ê°€ ì •í™•íˆ 100ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
                </div>
                <br>
                <button class="btn-primary" onclick="addCharacter()">íƒì‚¬ì ë“±ë¡</button>
            </div>

            <div id="char-list" class="char-grid"></div>

            <hr style="border-color:#333; margin:30px 0;">
            <button class="btn-primary" style="background:#2e7d32; height:50px;" onclick="startGame()">ğŸ² ì„¸ì…˜ ì‹œì‘ (Start Session)</button>
        </div>

        <div id="page-sim" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px;">
                <h2 style="margin:0;">ğŸ“œ í”Œë ˆì´ ë¡œê·¸</h2>
                <button class="btn-secondary" style="font-size:0.8em;" onclick="stopGame()">âš™ï¸ ì„¸ì…˜ ì¢…ë£Œ</button>
            </div>
            
            <div style="display:flex; gap:10px; margin:20px 0;">
                <button class="btn-primary" onclick="nextTurn()">ğŸŒ™ ë°¤ì„ ë³´ë‚¸ë‹¤ (Next Day)</button>
                <button class="btn-secondary" onclick="autoPlay()">â© ìë™ ì§„í–‰</button>
            </div>

            <div id="log-window">
                <div class="log-entry" style="color:#666;">
                    ...ì¹˜ì§... ê¸°ë¡ ì‹œì‘.<br>
                    ì´ê³³ì€ ìœ í´ë¦¬ë“œ ê¸°í•˜í•™ì´ í†µí•˜ì§€ ì•ŠëŠ” íí—ˆì…ë‹ˆë‹¤.<br>
                    ì‚´ì•„ë‚¨ìœ¼ë ¤ë©´ ì´ì„±(SAN)ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.
                </div>
            </div>

            <h3 style="margin-top:30px; border-left:4px solid #7b1fa2; padding-left:10px;">ìƒì¡´ì í˜„í™© (Inventory)</h3>
            <p style="font-size:0.8em; color:#888;">ğŸ’¡ ì•„ì´í…œ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.</p>
            <div id="sim-status" class="char-grid"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // 0. CoC & ì„œë¸Œì»¬ì³ ë°ì´í„° ì •ì˜
        // ==========================================
        const ITEMS = [
            { name: "ì‘ê¸‰ í‚¤íŠ¸", type: "hp", val: 25, desc: "ë¬¼ë¦¬ì  ìƒì²˜ë¥¼ ë´‰í•©í•©ë‹ˆë‹¤." },
            { name: "ë³´ì¡´ì‹ (í†µì¡°ë¦¼)", type: "food", val: 40, desc: "ë§›ì€ ë”ì°í•˜ì§€ë§Œ ì—´ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤." },
            { name: "ì§„ì •ì œ (ì•°í”Œ)", type: "sanity", val: 20, desc: "ë–¨ë¦¬ëŠ” ì†ì„ ë©ˆì¶”ê²Œ í•©ë‹ˆë‹¤." },
            { name: "ë‚¡ì€ ë¶€ì ", type: "sanity", val: 30, desc: "ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì–‘ì´ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤." },
            { name: "ê¹¨ë—í•œ ë¬¼", type: "food", val: 20, desc: "ì˜¤ì—¼ë˜ì§€ ì•Šì€ ê·€í•œ ë¬¼ì…ë‹ˆë‹¤." },
            { name: "ì—ë„ˆì§€ ë“œë§í¬", type: "food", val: 15, desc: "ê°ì„± íš¨ê³¼ê°€ ìˆìŠµë‹ˆë‹¤." },
            { name: "ê°€ì¡± ì‚¬ì§„", type: "sanity", val: 40, desc: "ëŒì•„ê°€ì•¼ í•  ì´ìœ ë¥¼ ìƒê¸°ì‹œí‚µë‹ˆë‹¤." },
            { name: "í¬íˆ´ë£¨ ì‹ í™”ì„œ", type: "sanity", val: -10, desc: "ì½ìœ¼ë©´ ì•ˆ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤..." } // í•¨ì • ì•„ì´í…œ
        ];

        const THREATS = [
            { name: "ë¹„ìœ í´ë¦¬ë“œ ê¸°í•˜í•™ì˜ ë°©", power: 70, text: "ë²½ê³¼ ì²œì¥ì˜ ê²½ê³„ê°€ ì‚¬ë¼ì§€ê³  ê³µê°„ì´ ë’¤í‹€ë¦½ë‹ˆë‹¤. (SAN ì²´í¬ í•„ìš”)" },
            { name: "ì‹¬í•´ì˜ êµ¬ìš¸ ë¬´ë¦¬", power: 90, text: "ì¶•ì¶•í•œ ì ì•¡ì§ˆë¡œ ë’¤ë®ì¸ ê´´ë¬¼ë“¤ì´ ì–´ë‘  ì†ì—ì„œ ìŠµê²©í•©ë‹ˆë‹¤!" },
            { name: "ë³„ì˜ í¡í˜ˆê·€ (Star Vampire)", power: 130, text: "ë³´ì´ì§€ ì•ŠëŠ” ë¬´ì–¸ê°€ê°€ ë™ë£Œì˜ í”¼ë¥¼ ê°ˆêµ¬í•˜ë©° ì›ƒìŒì†Œë¦¬ë¥¼ ëƒ…ë‹ˆë‹¤." },
            { name: "ê²€ì€ ì•ˆê°œ (The Fog)", power: 50, text: "í•œ ì¹˜ ì•ë„ ë³´ì´ì§€ ì•ŠëŠ” ì•ˆê°œ ì†ì—ì„œ ì†ì‚­ì„ì´ ë“¤ë ¤ì˜µë‹ˆë‹¤." },
            { name: "ì‡¼ê³ ìŠ¤ì˜ ì ì•¡", power: 110, text: "ì§€í•˜ì²  ì—­ì‚¬ê°€ ê±°ëŒ€í•œ ì ¤ë¦¬ ê°™ì€ ê´´ë¬¼ë¡œ ê°€ë“ ì°¹ë‹ˆë‹¤. 'í…Œì¼ˆë¦¬-ë¦¬!'" },
            { name: "í•˜ìŠ¤í„°ì˜ í™©ìƒ‰ ì§•í‘œ", power: 150, text: "ëˆ„êµ°ê°€ ë²½ì— ë…¸ë€ìƒ‰ í‘œì‹ì„ ê·¸ë ¸ìŠµë‹ˆë‹¤. ì³ë‹¤ë³´ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë¯¸ì¹  ê²ƒ ê°™ìŠµë‹ˆë‹¤." }
        ];

        const MAX_POINT = 100;

        // ==========================================
        // 1. ìœ í‹¸ë¦¬í‹° ë° ì…ë ¥ ë¡œì§
        // ==========================================
        function checkPoints() {
            const str = Number(document.getElementById('stat-str').value) || 0;
            const agi = Number(document.getElementById('stat-agi').value) || 0;
            const agg = Number(document.getElementById('stat-agg').value) || 0; // íˆ¬ì§€(POW)
            const act = Number(document.getElementById('stat-act').value) || 0; // ê´€ì°°(OBS)

            const total = str + agi + agg + act;
            const remain = MAX_POINT - total;
            
            const el = document.getElementById('remain-val');
            el.innerText = remain;
            
            const err = document.getElementById('point-error');
            if(remain !== 0) {
                el.style.color = "#ff5252"; 
                err.style.display = "block";
            } else {
                el.style.color = "#64b5f6"; 
                err.style.display = "none";
            }
            return remain;
        }

        // ==========================================
        // 2. ìºë¦­í„° ë°ì´í„° ê´€ë¦¬
        // ==========================================
        let characters = []; 
        let day = 0; 
        let isAutoPlaying = false;

        function calculateStats(mbti, bonusStats) {
            let stats = {
                hp: 100, maxHp: 100,
                sanity: 100, maxSanity: 100, // SANì¹˜
                food: 100, maxFood: 100,     // í¬ë§Œê°
                
                strength: 20, // ê·¼ë ¥
                agility: 20,  // ë¯¼ì²©
                aggro: 20,    // íˆ¬ì§€ (ì •ì‹ ë ¥ ë°©ì–´)
                active: 20,   // ê´€ì°° (íŒŒë°)
                conscience: 40 // í˜‘ë ¥ì‹¬
            };

            const chars = mbti.split('');
            // MBTI ë³´ì • (CoC ìŠ¤íƒ€ì¼ í•´ì„)
            if (chars[0] === 'E') stats.active += 30; else stats.sanity += 30; // ì™¸í–¥: ê´€ì°°ë ¥ / ë‚´í–¥: ë©˜íƒˆ
            if (chars[1] === 'S') stats.strength += 20; else stats.conscience += 20;
            if (chars[2] === 'T') stats.aggro += 30; else stats.conscience += 20; // ì‚¬ê³ : íˆ¬ì§€ / ê°ì •: í˜‘ë ¥
            if (chars[3] === 'J') stats.strength += 20; else stats.agility += 20;

            // ìœ ì € í¬ì¸íŠ¸
            stats.strength += bonusStats.str;
            stats.agility += bonusStats.agi;
            stats.aggro += bonusStats.agg;
            stats.active += bonusStats.act;

            return stats;
        }

        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            
            if (checkPoints() !== 0) return alert("ìŠ¤íƒ¯ í¬ì¸íŠ¸ í•©ê³„ë¥¼ 100ìœ¼ë¡œ ë§ì¶°ì£¼ì„¸ìš”!");
            if (!name) return alert("íƒì‚¬ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const bonusStats = {
                str: Number(document.getElementById('stat-str').value),
                agi: Number(document.getElementById('stat-agi').value),
                agg: Number(document.getElementById('stat-agg').value), // POW
                act: Number(document.getElementById('stat-act').value)  // OBS
            };

            const newChar = {
                id: Date.now(),
                name: name,
                mbti: mbti,
                bonusStats: bonusStats,
                stats: calculateStats(mbti, bonusStats),
                inventory: [], 
                relations: {}
            };

            characters.push(newChar);
            renderCharList();
            
            // ì´ˆê¸°í™”
            document.getElementById('input-name').value = ''; 
            document.getElementById('stat-str').value = 0;
            document.getElementById('stat-agi').value = 0;
            document.getElementById('stat-agg').value = 0;
            document.getElementById('stat-act').value = 0;
            checkPoints();
        }

        function deleteCharacter(id) {
            characters = characters.filter(c => c.id !== id);
            renderCharList();
        }

        function renderCharList() {
            const list = document.getElementById('char-list');
            list.innerHTML = characters.map(c => `
                <div class="char-card">
                    <button style="position:absolute; top:10px; right:10px; width:24px; height:24px; padding:0; background:#c62828;" onclick="deleteCharacter(${c.id})">Ã—</button>
                    <div class="char-header">
                        <span class="char-name">${c.name}</span>
                        <span class="char-class">${c.mbti}</span>
                    </div>
                    <div class="stat-row"><span>HP (ì²´ë ¥)</span> <span>${c.stats.hp}</span></div>
                    <div class="stat-row"><span>SAN (ì´ì„±)</span> <span>${c.stats.sanity}</span></div>
                    <div class="stat-row"><span>FOOD (í¬ë§Œ)</span> <span>${c.stats.food}</span></div>
                </div>
            `).join('');
        }

        // ==========================================
        // 3. ì•„ì´í…œ ìˆ˜ë™ ì‚¬ìš© (í•µì‹¬ ë³€ê²½ì )
        // ==========================================
        function useItem(charId, itemIdx) {
            const char = characters.find(c => c.id === charId);
            if (!char || char.stats.hp <= 0) return alert("ì‚¬ë§í•œ ìºë¦­í„°ëŠ” ì•„ì´í…œì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const item = char.inventory[itemIdx];
            
            // íš¨ê³¼ ì ìš©
            if (item.type === 'hp') {
                char.stats.hp = Math.min(char.stats.maxHp, char.stats.hp + item.val);
                alert(`[${char.name}] ì²´ë ¥ íšŒë³µ! (+${item.val})`);
            } else if (item.type === 'sanity') {
                char.stats.sanity = Math.min(char.stats.maxSanity, char.stats.sanity + item.val);
                alert(`[${char.name}] ì •ì‹ ì´ ë§‘ì•„ì§‘ë‹ˆë‹¤. (SAN +${item.val})`);
            } else if (item.type === 'food') {
                char.stats.food = Math.min(char.stats.maxFood, char.stats.food + item.val);
                alert(`[${char.name}] ë°°ë¥¼ ì±„ì› ìŠµë‹ˆë‹¤. (í¬ë§Œê° +${item.val})`);
            }

            // ë¡œê·¸ ê¸°ë¡
            addLog(`<span class="txt-sys">ğŸ’ <b>${char.name}</b>(ì´)ê°€ [${item.name}]ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.</span>`);

            // ì•„ì´í…œ ì†Œëª¨ ë° í™”ë©´ ê°±ì‹ 
            char.inventory.splice(itemIdx, 1);
            updateSimStatus();
        }

        // ==========================================
        // 4. ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„
        // ==========================================
        function startGame() {
            if (characters.length < 1) return alert("ìµœì†Œ 1ëª…ì˜ íƒì‚¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            
            characters.forEach(c1 => {
                characters.forEach(c2 => {
                    if (c1.id !== c2.id && !c1.relations[c2.name]) c1.relations[c2.name] = 0;
                });
            });

            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            addLog(`ğŸ“¢ í‚¤í¼(Keeper): ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. ìƒì¡´ì ${characters.length}ëª….`);
            updateSimStatus();
        }

        function stopGame() {
            if(confirm("ì„¸ì…˜ì„ ê°•ì œ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                document.getElementById('page-sim').classList.remove('active');
                document.getElementById('page-setup').classList.add('active');
                isAutoPlaying = false;
            }
        }

        function nextTurn() {
            day++;
            addLog(`<div style="margin-top:15px; border-bottom:1px solid #333;"><span class="txt-day">Day ${day}</span></div>`);

            const survivors = characters.filter(c => c.stats.hp > 0);
            if (survivors.length < 1) {
                addLog("<span style='color:red; font-size:1.2em;'>ğŸ’€ ì „ë©¸(Bad End). ì•„ë¬´ë„ ì‹¬ì—°ì—ì„œ ëŒì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>");
                isAutoPlaying = false;
                return;
            }

            // 1. ë°°ê³ í”” ì²˜ë¦¬
            survivors.forEach(c => {
                c.stats.food -= 10;
                if (c.stats.food < 0) {
                    c.stats.food = 0;
                    c.stats.hp -= 15;
                    addLog(`<span class="txt-sys">.. ${c.name}(ì€)ëŠ” êµ¶ì£¼ë¦¼ì— ëˆˆì•ì´ ìº„ìº„í•´ì§‘ë‹ˆë‹¤. (HP -15)</span>`);
                }
            });

            // 2. ì´ë²¤íŠ¸ ë¡¤
            const eventRoll = Math.random();
            
            if (eventRoll < 0.35) {
                processThreat(survivors); // 35% ìœ„í˜‘
            } else if (eventRoll < 0.65) {
                processScavenge(survivors); // 30% íŒŒë°
            } else {
                processInteraction(survivors); // 35% ìƒí˜¸ì‘ìš©
            }

            updateSimStatus();
        }

        // [ì´ë²¤íŠ¸: ì™¸ë¶€ ìœ„í˜‘ (CoC Flavor)]
        function processThreat(survivors) {
            const threat = THREATS[Math.floor(Math.random() * THREATS.length)];
            addLog(`<span class="txt-threat">[ê²½ê³ ] ${threat.text}</span>`);

            // ì „íˆ¬ë ¥ = ê·¼ë ¥(STR) + ë¯¼ì²©(DEX) + íˆ¬ì§€(POW)
            let teamPower = 0;
            survivors.forEach(c => teamPower += (c.stats.strength + c.stats.agility + c.stats.aggro)/3);
            teamPower += (Math.random() * 60); 

            if (teamPower >= threat.power) {
                addLog(`<span style="color:#2ecc71;">âœ… ì£¼ì‚¬ìœ„ ì„±ê³µ! ìƒì¡´ìë“¤ì´ ìœ„í˜‘ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤.</span>`);
                survivors.forEach(c => {
                    c.stats.sanity -= 5; 
                    c.stats.food -= 5;   
                });
            } else {
                addLog(`<span style="color:#e74c3c;">âŒ ì£¼ì‚¬ìœ„ ì‹¤íŒ¨! ì••ë„ì ì¸ ê³µí¬ê°€ ë®ì³ì˜µë‹ˆë‹¤.</span>`);
                const dmg = Math.floor((threat.power - teamPower) / survivors.length) + 10;
                survivors.forEach(c => {
                    c.stats.hp -= dmg;
                    c.stats.sanity -= 10;
                    addLog(`.. ${c.name}: ë¹„ëª…ì„ ì§€ë¥´ë©° í”¼í•´ë¥¼ ì…ìŠµë‹ˆë‹¤ (HP -${dmg})`);
                });
            }
        }

        // [ì´ë²¤íŠ¸: íŒŒë° (ìˆ˜ë™ ì•„ì´í…œ íšë“)]
        function processScavenge(survivors) {
            addLog(`<span class="txt-item">[íƒìƒ‰] ìƒì¡´ìë“¤ì´ íí—ˆë¥¼ ì¡°ì‚¬í•©ë‹ˆë‹¤... (ê´€ì°°ë ¥ íŒì •)</span>`);
            
            survivors.forEach(c => {
                // ê´€ì°°ë ¥(OBS) + ë¯¼ì²©(DEX) íŒì •
                const chance = (c.stats.active + c.stats.agility) / 2 + 15;
                if (Math.random() * 100 < chance) {
                    const item = ITEMS[Math.floor(Math.random() * ITEMS.length)];
                    // ì•„ì´í…œ ê°ì²´ ë³µì‚¬í•´ì„œ ë„£ê¸°
                    c.inventory.push({...item}); 
                    addLog(`.. ğŸ” <b>${c.name}</b>: [${item.name}] ë°œê²¬!`);
                } else {
                    addLog(`.. ${c.name}: ì•„ë¬´ê²ƒë„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
                    c.stats.food -= 3;
                }
            });
        }

        // [ì´ë²¤íŠ¸: ìƒí˜¸ì‘ìš© (ê´‘ê¸° í¬í•¨)]
        function processInteraction(survivors) {
            if (survivors.length < 2) return;

            const actor = survivors[Math.floor(Math.random() * survivors.length)];
            let target = survivors[Math.floor(Math.random() * survivors.length)];
            while(actor.id === target.id) target = survivors[Math.floor(Math.random() * survivors.length)];

            // SANì¹˜(ì´ì„±) ì²´í¬
            if (actor.stats.sanity < 30) {
                addLog(`<span class="txt-sanity">[ê´‘ê¸° ë°œì‘] <b>${actor.name}</b>ì˜ ëˆˆë¹›ì´ ë§›ì´ ê°”ìŠµë‹ˆë‹¤. "ê·¸ë“¤ì´.. ë‚´ ë‡Œë¥¼ íŒŒë¨¹ê³  ìˆì–´!!"</span>`);
                addLog(`.. ${actor.name}(ì´)ê°€ ${target.name}ë¥¼ ê³µê²©í•©ë‹ˆë‹¤!`);
                target.stats.hp -= 25;
            }
            else {
                addLog(`ğŸ’¬ <b>${actor.name}</b>(ì™€)ê³¼ <b>${target.name}</b>(ì€)ëŠ” ì ì‹œ ìˆ¨ì„ ëŒë¦¬ë©° ëŒ€í™”í•©ë‹ˆë‹¤.`);
                actor.stats.sanity += 5; target.stats.sanity += 5;
            }
        }

        // ==========================================
        // 5. í™”ë©´ ê°±ì‹  (ì•„ì´í…œ ë²„íŠ¼ ë Œë”ë§ í¬í•¨)
        // ==========================================
        function updateSimStatus() {
            const container = document.getElementById('sim-status');
            container.innerHTML = characters.map(c => {
                const isDead = c.stats.hp <= 0;
                const hpPct = Math.max(0, (c.stats.hp/c.stats.maxHp)*100);
                const sanPct = Math.max(0, (c.stats.sanity/c.stats.maxSanity)*100);
                const foodPct = Math.max(0, (c.stats.food/c.stats.maxFood)*100);
                
                let statusClass = "char-card";
                if (c.stats.sanity < 30) statusClass += " madness"; // ê´‘ê¸° ìƒíƒœ í…Œë‘ë¦¬
                if (c.stats.hp < 30) statusClass += " danger"; // ìœ„ê¸‰ ìƒíƒœ

                if (isDead) return `<div class="char-card" style="opacity:0.3; filter:grayscale(100%);"><div class="char-name">ğŸ’€ ${c.name} (ì‚¬ë§)</div></div>`;

                // ì•„ì´í…œ ë²„íŠ¼ ë¦¬ìŠ¤íŠ¸ ìƒì„±
                let invHtml = `<div class="inv-label">ê°€ë°© (í´ë¦­í•˜ì—¬ ì‚¬ìš©)</div>`;
                if (c.inventory.length === 0) {
                    invHtml += `<span style="font-size:0.7em; color:#555;">ë¹„ì–´ìˆìŒ</span>`;
                } else {
                    c.inventory.forEach((item, idx) => {
                        invHtml += `<button class="item-btn" onclick="useItem(${c.id}, ${idx})" title="${item.desc}">${item.name}</button>`;
                    });
                }

                return `
                <div class="${statusClass}">
                    <div class="char-name">${c.name} <span style="font-size:0.7em; color:#666;">${c.stats.sanity<30?'(ê´‘ê¸°)':''}</span></div>
                    
                    <div class="stat-row">
                        <span>HP</span> <div class="bar-bg"><div class="bar-fill" style="width:${hpPct}%; background:var(--hp-color)"></div></div> <span>${Math.floor(c.stats.hp)}</span>
                    </div>
                    <div class="stat-row">
                        <span>SAN</span> <div class="bar-bg"><div class="bar-fill" style="width:${sanPct}%; background:var(--san-color)"></div></div> <span>${Math.floor(c.stats.sanity)}</span>
                    </div>
                    <div class="stat-row">
                        <span>FOOD</span> <div class="bar-bg"><div class="bar-fill" style="width:${foodPct}%; background:var(--food-color)"></div></div> <span>${Math.floor(c.stats.food)}</span>
                    </div>

                    <div class="inv-area">
                        ${invHtml}
                    </div>
                </div>
            `}).join('');
        }

        function addLog(html) {
            const win = document.getElementById('log-window');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = html;
            win.appendChild(entry);
            win.scrollTop = win.scrollHeight;
        }

        function autoPlay() {
            if (isAutoPlaying) return;
            isAutoPlaying = true;
            addLog("â© ìë™ ì§„í–‰ ì‹œì‘... (ì•„ì´í…œ ì‚¬ìš© íƒ€ì´ë°ì„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”!)");
            const timer = setInterval(() => {
                const living = characters.filter(c => c.stats.hp > 0).length;
                if (!isAutoPlaying || living < 1) {
                    clearInterval(timer);
                    isAutoPlaying = false;
                } else {
                    nextTurn();
                }
            }, 1500); 
        }

        checkPoints();

    </script>
</body>
</html>
