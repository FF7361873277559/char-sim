<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Abyss Survivors: Relations</title>
    <style>
        /* =========================================
           1. í…Œë§ˆ ì„¤ì • (Teal #00a588 Dark Theme)
           ========================================= */
        :root {
            --bg-color: #050606;
            --container-bg: #101214;
            --panel-bg: #1a1e21;
            
            --main-accent: #00897b;    /* ì§™ì€ ì²­ë¡ */
            --bright-accent: #1de9b6;  /* í˜•ê´‘ ë¯¼íŠ¸ */
            --hover-accent: #00bfa5;
            
            --text-main: #eceff1;
            --text-sub: #78909c;
            
            --hp-color: #d32f2f;
            --san-color: #7b1fa2;
            --food-color: #fbc02d;
            --rel-plus: #4caf50;       /* í˜¸ê°ë„ í”ŒëŸ¬ìŠ¤ */
            --rel-minus: #ff5252;      /* í˜¸ê°ë„ ë§ˆì´ë„ˆìŠ¤ */
            
            --btn-bg: #263238;
            --border-color: #2c3830;
        }

        body { 
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            height: 100vh; box-sizing: border-box; overflow: hidden;
        }

        .container { 
            max-width: 1500px; margin: 0 auto; 
            background: var(--container-bg); 
            height: 100%; border-radius: 6px; border: 1px solid #37474f; 
            display: flex; flex-direction: column;
            box-shadow: 0 0 60px rgba(0, 137, 123, 0.1);
        }

        .header { 
            padding: 15px 25px; border-bottom: 1px solid #37474f; 
            flex-shrink: 0; display:flex; justify-content:space-between; align-items:center;
            background: linear-gradient(90deg, #0a0c0d, #14181a);
        }
        h1 { margin: 0; color: var(--bright-accent); font-size: 1.5em; text-shadow: 0 0 10px rgba(29, 233, 182, 0.4); }
        
        .page { display: none; height: 100%; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #page-sim.active { display: flex; gap: 20px; padding: 20px; overflow: hidden; }
        .sim-left { flex: 1.2; display: flex; flex-direction: column; min-width: 0; }
        .sim-right { 
            flex: 1; display: flex; flex-direction: column; overflow-y: auto; 
            min-width: 400px; gap: 15px; padding-right: 5px;
        }

        /* ë¡œê·¸ ì°½ */
        #log-window { 
            flex-grow: 1; overflow-y: auto; 
            background: #0b0d0e; border: 1px solid #37474f; 
            padding: 20px; font-family: 'Consolas', monospace; font-size: 0.9em; 
            border-radius: 4px; color: #b0bec5; line-height: 1.7;
        }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #1c2224; padding-bottom: 6px; }
        .txt-day { color: var(--main-accent); font-weight: bold; background: rgba(0, 137, 123, 0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        .txt-threat { color: #ef5350; font-weight: bold; }
        .txt-item { color: #ffb74d; }
        .txt-social { color: #81d4fa; } /* ëŒ€í™”/ê´€ê³„ ë¡œê·¸ */
        .txt-clash { color: #ffab91; }  /* ê°ˆë“± ë¡œê·¸ */
        .txt-bond { color: #a5d6a7; }   /* ìœ ëŒ€ ë¡œê·¸ */

        /* ê³µìš© ì¸ë²¤í† ë¦¬ */
        .inventory-box {
            background: var(--panel-bg); border: 1px solid #37474f;
            padding: 15px; border-radius: 4px;
        }
        .inv-title { font-weight: bold; color: var(--bright-accent); margin-bottom: 12px; display:block; border-bottom:1px solid #37474f; padding-bottom:5px;}
        .inv-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .item-btn { 
            background: #263238; color: #cfd8dc; border: 1px solid #455a64;
            padding: 6px 12px; font-size: 0.85em; cursor: pointer; border-radius: 2px;
            transition: 0.2s;
        }
        .item-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; }

        /* ìºë¦­í„° ì¹´ë“œ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .char-card { 
            background: var(--panel-bg); border: 1px solid #37474f; padding: 15px; 
            border-left: 3px solid #546e7a; border-radius: 4px;
            position: relative; transition: border-color 0.3s;
        }
        .char-card.danger { border-left-color: var(--hp-color); }
        .char-card.madness { border-left-color: var(--san-color); }

        .char-header { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-end; }
        .char-name { font-weight: bold; font-size: 1.1em; color: var(--bright-accent); }
        .char-meta { font-size: 0.75em; color: var(--text-sub); }

        /* ê·¸ë˜í”„ ë°” */
        .stat-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; color: #90a4ae; margin-top: 4px; }
        .bar-bg { 
            flex-grow: 1; background: #263238; height: 5px; margin: 0 10px; 
            border-radius: 2px; overflow: hidden; 
        }
        .bar-fill { height: 100%; transition: width 0.4s ease-out; max-width: 100%; }
        
        /* ê´€ê³„ ë° ìŠ¤íƒ¯ ì •ë³´ ë°•ìŠ¤ */
        .info-box { 
            display: flex; justify-content: space-between; margin-top: 10px; padding-top: 8px; 
            border-top: 1px dashed #37474f; font-size: 0.75em; color: #78909c;
        }
        .rel-box {
            margin-top: 8px; padding: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.8em;
        }
        .rel-tag { display: inline-block; margin-right: 5px; padding: 1px 4px; border-radius: 3px; background:#263238; color:#ccc;}
        .rel-val.plus { color: var(--rel-plus); }
        .rel-val.minus { color: var(--rel-minus); }

        /* ì…ë ¥ í¼ (Setup) */
        .input-section { background: rgba(38, 50, 56, 0.3); padding: 25px; border:1px solid #37474f; border-radius: 6px;}
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { 
            width: 100%; padding: 12px; background: #161b1d; 
            border: 1px solid #455a64; color: white; border-radius: 2px;
        }
        input:focus, select:focus { border-color: var(--main-accent); outline: none; }

        /* ìŠ¤íƒ¯ ë¶„ë°° ë°•ìŠ¤ */
        .stat-dist-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px; }
        .stat-input-group label { display: block; text-align: center; font-size: 0.8em; color: var(--text-sub); margin-bottom: 5px; }
        .stat-input-group input { text-align: center; font-weight: bold; color: var(--bright-accent); }
        
        /* ê³µí†µ ë²„íŠ¼ */
        .btn-main { 
            background: var(--main-accent); color: white; border: none; padding: 12px 20px; 
            font-weight: bold; cursor: pointer; font-size: 1em; width: 100%; border-radius: 4px; transition: 0.2s;
        }
        .btn-main:hover { background: var(--hover-accent); box-shadow: 0 0 15px rgba(0, 137, 123, 0.4); }
        .btn-sub { background: var(--btn-bg); color: var(--text-sub); border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }

        /* ëª¨ë‹¬ì°½ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 1000;
            justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal-box {
            background: var(--panel-bg); border: 1px solid var(--main-accent); padding: 25px;
            width: 450px; max-width: 90%; border-radius: 6px; 
            text-align: center; box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }
        .target-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
        .target-btn {
            background: #263238; border: 1px solid #455a64; color: #eceff1; padding: 10px; cursor: pointer;
            border-radius: 4px; transition: 0.2s; font-size: 0.9em;
        }
        .target-btn:hover { background: var(--main-accent); border-color: var(--bright-accent); color: white; }
        .target-btn.dead { opacity: 0.4; pointer-events: none; text-decoration: line-through; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>ğŸ‘ï¸ Abyss Survivors <span style="font-size:0.6em; color:#546e7a;">v5.0</span></h1>
            <div id="setup-btn-group" style="display:none;">
                <button class="btn-sub" onclick="stopGame()">âš™ï¸ ì¢…ë£Œ</button>
            </div>
        </div>

        <div id="page-setup" class="page active">
            <div style="max-width: 900px; margin: 0 auto;">
                <p style="color:var(--text-sub); margin-bottom: 20px;">ì‹¬ì—°ì—ì„œ ì„œë¡œ ì˜ì§€í•˜ê±°ë‚˜, ì„œë¡œë¥¼ íŒŒë©¸ì‹œí‚¬ íƒì‚¬ìë“¤ì„ ë“±ë¡í•˜ì‹­ì‹œì˜¤.</p>
                
                <div class="input-section">
                    <div class="input-group">
                        <input type="text" id="input-name" placeholder="íƒì‚¬ì ì´ë¦„ (Ex. K)">
                        <select id="input-mbti">
                            <option value="INTJ">INTJ (ì „ëµê°€)</option>
                            <option value="INTP">INTP (ì—°êµ¬ê°€)</option>
                            <option value="INFJ">INFJ (ì˜ˆì–¸ì)</option>
                            <option value="INFP">INFP (ëª½ìƒê°€)</option>
                            <option value="ISTJ">ISTJ (ê´€ë¦¬ì)</option>
                            <option value="ISFJ">ISFJ (ìˆ˜í˜¸ì)</option>
                            <option value="ISTP">ISTP (ê¸°ìˆ ì)</option>
                            <option value="ISFP">ISFP (ì˜ˆìˆ ê°€)</option>
                            <option value="ENTJ">ENTJ (í†µì†”ì)</option>
                            <option value="ENTP">ENTP (ë³€ë¡ ê°€)</option>
                            <option value="ENFJ">ENFJ (ìš´ë™ê°€)</option>
                            <option value="ENFP">ENFP (í™œë™ê°€)</option>
                            <option value="ESTJ">ESTJ (ê²½ì˜ì)</option>
                            <option value="ESTP">ESTP (ì‚¬ì—…ê°€)</option>
                            <option value="ESFJ">ESFJ (ì™¸êµê´€)</option>
                            <option value="ESFP">ESFP (ììœ ì¸)</option>
                        </select>
                    </div>

                    <div class="stat-dist-box">
                        <div class="stat-input-group"><label>ê·¼ë ¥(STR)</label><input type="number" id="stat-str" value="0" min="0" oninput="checkPoints()"></div>
                        <div class="stat-input-group"><label>ë¯¼ì²©(AGI)</label><input type="number" id="stat-agi" value="0" min="0" oninput="checkPoints()"></div>
                        <div class="stat-input-group"><label>íˆ¬ì§€(POW)</label><input type="number" id="stat-pow" value="0" min="0" oninput="checkPoints()"></div>
                        <div class="stat-input-group"><label>ê´€ì°°(OBS)</label><input type="number" id="stat-obs" value="0" min="0" oninput="checkPoints()"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="remain-txt" style="font-size:0.9em; color:#78909c;">ì”ì—¬ í¬ì¸íŠ¸: <span id="remain-val" style="color:var(--bright-accent); font-weight:bold;">100</span></span>
                        <button class="btn-main" onclick="addCharacter()" style="width:auto; padding:10px 25px;">ë“±ë¡</button>
                    </div>
                    <div id="point-error" style="color:#ef5350; font-size:0.9em; display:none; margin-top:5px;">âš ï¸ í¬ì¸íŠ¸ í•©ê³„ëŠ” 100ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>
                </div>

                <div id="setup-list" class="char-grid" style="margin-top:20px;"></div>
                
                <div style="margin-top: 40px; text-align: center;">
                    <button class="btn-main" style="padding: 15px 40px; font-size: 1.2em; width:auto;" onclick="startGame()">ğŸ² ì„¸ì…˜ ì‹œì‘</button>
                </div>
            </div>
        </div>

        <div id="page-sim" class="page">
            <div class="sim-left">
                <button class="btn-main" onclick="nextTurn()">ğŸŒ™ ë‹¤ìŒ ë‚  (Next Day)</button>
                <div id="log-window">
                    <div class="log-entry" style="color:#546e7a;">ê¸°ë¡ ì¥ì¹˜ ê°€ë™...</div>
                </div>
            </div>
            <div class="sim-right">
                <div class="inventory-box">
                    <span class="inv-title">ğŸ“¦ ê³µìš© ë¬¼ì</span>
                    <div id="shared-inv" class="inv-grid"><span style="color:#546e7a; font-size:0.9em;">ë¹„ì–´ìˆìŒ</span></div>
                </div>
                <div id="sim-char-list" class="char-grid"></div>
            </div>
        </div>
    </div>

    <div id="item-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="color:var(--bright-accent); margin-top:0;"></h3>
            <p id="modal-desc" style="color:#ccc; font-size:0.9em;"></p>
            <div id="modal-targets" class="target-list"></div>
            <button class="btn-sub" onclick="closeModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ==========================================
        // 0. ë°ì´í„° ë° ìƒìˆ˜
        // ==========================================
        const MAX_POINTS = 100;
        
        const ITEMS = [
            { name: "ì‘ê¸‰ í‚¤íŠ¸", type: "hp", val: 35, desc: "HP +35 íšŒë³µ" },
            { name: "ì „íˆ¬ ì‹ëŸ‰", type: "food", val: 50, desc: "ì‹ëŸ‰ +50" },
            { name: "ì§„ì •ì œ", type: "sanity", val: 25, desc: "ì´ì„± +25 íšŒë³µ" },
            { name: "ì •í™”ìˆ˜", type: "food", val: 20, desc: "ì‹ëŸ‰ +20" },
            { name: "ì—˜ë” ì‚¬ì¸", type: "sanity", val: 50, desc: "ê°•ë ¥í•œ ì •ì‹  ë³´í˜¸ (ì´ì„± +50)" },
            { name: "êµ°ìš© ìŠ¤íŒ€íŒ©", type: "hp", val: 15, desc: "HP +15" },
            { name: "ì˜¤ë˜ëœ ì¼ê¸°", type: "sanity", val: 15, desc: "ëˆ„êµ°ê°€ì˜ ê¸°ë¡ (ì´ì„± +15)" }
        ];

        // í¬íˆ´ë£¨ í…Œë§ˆ ìœ„í˜‘ (í™•ì¥ë¨)
        const THREATS = [
            { name: "ìš°ì£¼ì—ì„œ ì˜¨ ìƒ‰ì±„", power: 90, text: "ìš°ë¬¼ê°€ì—ì„œ ê¸°ì´í•œ ìƒ‰ì±„ê°€ í”¼ì–´ì˜¤ë¦…ë‹ˆë‹¤. ìƒëª…ë ¥ì„ ë¹¨ì•„ë“¤ì…ë‹ˆë‹¤." },
            { name: "í‹´ë‹¬ë¡œìŠ¤ì˜ ì‚¬ëƒ¥ê°œ", power: 130, text: "ë°©ì˜ ëª¨ì„œë¦¬ì—ì„œ ì—°ê¸°ê°€ í”¼ì–´ì˜¤ë¥´ë©° ì‚¬ëƒ¥ê°œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!" },
            { name: "ë¯¸-ê³ ì˜ ë‡Œ ìˆ˜ìˆ ", power: 110, text: "ë‚ ê°œ ë‹¬ë¦° ê°‘ê°ë¥˜ ê´´ë¬¼ë“¤ì´ ë‹¹ì‹ ë“¤ì˜ ë‡Œë¥¼ ë…¸ë¦½ë‹ˆë‹¤." },
            { name: "í¬í† ë‹ˆì•ˆì˜ ì§€ì§„", power: 100, text: "ë•…ì´ ê°ˆë¼ì§€ë©° ê±°ëŒ€í•œ ì´‰ìˆ˜ê°€ ì†Ÿêµ¬ì¹©ë‹ˆë‹¤." },
            { name: "ë³„ì˜ í¡í˜ˆê·€", power: 120, text: "ë³´ì´ì§€ ì•ŠëŠ” ë¬´ì–¸ê°€ê°€ ì›ƒìŒì†Œë¦¬ë¥¼ ë‚´ë©° í”¼ë¥¼ ê°ˆêµ¬í•©ë‹ˆë‹¤." },
            { name: "ë‹¤ê³¤ì˜ ë¶€ë¦„", power: 140, text: "í•´ì•ˆê°€ì—ì„œ ê±°ëŒ€í•œ ë°˜ì¸ë°˜ì–´ ê´´ìˆ˜ê°€ ê±¸ì–´ ë‚˜ì˜µë‹ˆë‹¤." },
            { name: "ê´‘ê¸°ì˜ ì‚°ë§¥", power: 80, text: "ê¸°ê´´í•œ í”¼ë¦¬ ì†Œë¦¬ê°€ ë“¤ë ¤ì™€ ì •ì‹ ì„ í˜¼ë¯¸í•˜ê²Œ í•©ë‹ˆë‹¤." },
            { name: "ë¥¼ë¦¬ì—ì˜ ì•…ëª½", power: 70, text: "ì ë“  ì‚¬ì´ ì‹¬í•´ì˜ ë„ì‹œë¥¼ ê±·ëŠ” ì•…ëª½ì„ ê¿‰ë‹ˆë‹¤." }
        ];

        let characters = [];
        let partyInventory = [];
        let day = 0;
        let selectedItemIndex = -1;

        // ==========================================
        // 1. ìºë¦­í„° ë° ê´€ê³„ ìƒì„±
        // ==========================================
        function checkPoints() {
            const vals = [
                Number(document.getElementById('stat-str').value)||0,
                Number(document.getElementById('stat-agi').value)||0,
                Number(document.getElementById('stat-pow').value)||0,
                Number(document.getElementById('stat-obs').value)||0
            ];
            const remain = MAX_POINTS - vals.reduce((a,b)=>a+b, 0);
            const rTxt = document.getElementById('remain-val');
            rTxt.innerText = remain;
            rTxt.style.color = remain===0 ? "var(--bright-accent)" : "#ef5350";
            document.getElementById('point-error').style.display = remain===0 ? 'none' : 'block';
            return remain;
        }

        function calculateAttributes(mbti, userStats) {
            let attr = { str: 20+userStats.str, agi: 20+userStats.agi, pow: 20+userStats.pow, obs: 20+userStats.obs };
            const m = mbti.split('');
            // MBTI ë³´ë„ˆìŠ¤
            if(m[0]==='E') attr.obs+=10; else attr.pow+=10;
            if(m[1]==='S') attr.str+=10; else attr.pow+=10;
            if(m[2]==='T') attr.str+=10; else attr.obs+=10;
            if(m[3]==='J') attr.str+=10; else attr.agi+=10;
            return attr;
        }

        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            if(checkPoints() !== 0) return alert("í¬ì¸íŠ¸ í•©ê³„ë¥¼ 100ìœ¼ë¡œ ë§ì¶°ì£¼ì„¸ìš”.");
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            const uStats = {
                str: Number(document.getElementById('stat-str').value),
                agi: Number(document.getElementById('stat-agi').value),
                pow: Number(document.getElementById('stat-pow').value),
                obs: Number(document.getElementById('stat-obs').value)
            };

            const char = {
                id: Date.now(),
                name: name,
                mbti: mbti,
                resources: { hp: 100, maxHp: 100, sanity: 100, maxSanity: 100, food: 100, maxFood: 100 },
                attr: calculateAttributes(mbti, uStats),
                relations: {} 
            };
            
            characters.push(char);
            
            // ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('input-name').value = '';
            ['str','agi','pow','obs'].forEach(id=>document.getElementById('stat-'+id).value=0);
            checkPoints();
            renderSetupList();
        }

        function renderSetupList() {
            document.getElementById('setup-list').innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-header"><span class="char-name">${c.name}</span><span class="char-meta">${c.mbti}</span></div>
                    <div class="info-box">STR:${c.attr.str} AGI:${c.attr.agi} POW:${c.attr.pow} OBS:${c.attr.obs}</div>
                </div>
            `).join('');
        }

        // ==========================================
        // 2. ë©”ì¸ ê²Œì„ ë£¨í”„
        // ==========================================
        function startGame() {
            if(characters.length < 1) return alert("ìµœì†Œ 1ëª…ì˜ íƒì‚¬ìê°€ í•„ìš”í•©ë‹ˆë‹¤.");
            
            // ê´€ê³„ ì´ˆê¸°í™”
            characters.forEach(c1 => {
                characters.forEach(c2 => {
                    if(c1.id !== c2.id) {
                        c1.relations[c2.name] = 0;
                    }
                });
            });

            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            document.getElementById('setup-btn-group').style.display = 'block';
            partyInventory = [{...ITEMS[0]}, {...ITEMS[1]}];
            
            addLog("ğŸ“¢ ì‹¬ì—°ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì„œë¡œë¥¼ ë¯¿ìœ¼ì‹­ì‹œì˜¤... í•  ìˆ˜ ìˆë‹¤ë©´.");
            updateUI();
        }

        function stopGame() {
            if(confirm("ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                location.reload(); // ê°„ë‹¨íˆ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì´ˆê¸°í™”
            }
        }

        function nextTurn() {
            day++;
            addLog(`<div style="margin:20px 0 10px 0; border-top:1px dashed #333; padding-top:10px;"><span class="txt-day">Day ${day}</span></div>`);

            const survivors = characters.filter(c => c.resources.hp > 0);
            if(survivors.length === 0) {
                addLog("<div style='color:#ef5350; font-size:1.2em; text-align:center;'>ğŸ’€ ì „ì› ì‚¬ë§. Game Over.</div>");
                return;
            }

            // 1. ìì› ì†Œëª¨
            survivors.forEach(c => {
                c.resources.food -= 15;
                if(c.resources.food < 0) {
                    c.resources.food = 0;
                    c.resources.hp -= 10;
                    addLog(`<span style="color:#78909c;">.. ${c.name}: í—ˆê¸°ë¡œ ì¸í•´ ê³ í†µë°›ìŠµë‹ˆë‹¤. (HP -10)</span>`);
                }
            });

            // 2. ì´ë²¤íŠ¸ í˜ì´ì¦ˆ (ìœ„í˜‘ or íƒìƒ‰)
            const roll = Math.random();
            if(roll < 0.4) processScavenge(survivors);
            else processThreat(survivors);

            // 3. ì‚¬íšŒì  ìƒí˜¸ì‘ìš© í˜ì´ì¦ˆ (í•­ìƒ ë°œìƒ)
            processSocial(survivors);

            updateUI();
        }

        // ==========================================
        // 3. ì´ë²¤íŠ¸ ë¡œì§
        // ==========================================
        function processScavenge(survivors) {
            addLog(`<span class="txt-item">[íƒìƒ‰]</span> ê²€ì€ íí—ˆë¥¼ ì¡°ì‚¬í•©ë‹ˆë‹¤.`);
            let found = false;
            survivors.forEach(c => {
                if(Math.random()*100 < c.attr.obs + 10) {
                    const item = ITEMS[Math.floor(Math.random()*ITEMS.length)];
                    partyInventory.push({...item});
                    addLog(`.. ğŸ” <b>${c.name}</b>: [${item.name}] ë°œê²¬.`);
                    found = true;
                }
            });
            if(!found) addLog(`.. ì•„ë¬´ê²ƒë„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
        }

        function processThreat(survivors) {
            const threat = THREATS[Math.floor(Math.random()*THREATS.length)];
            addLog(`<span class="txt-threat">[ìœ„í˜‘] ${threat.text} (ë‚œì´ë„: ${threat.power})</span>`);
            
            // íŒŒí‹° ì „íˆ¬ë ¥: ê·¼ë ¥+ë¯¼ì²©+íˆ¬ì§€ í•©ì‚° í‰ê· 
            let teamPower = survivors.reduce((sum,c) => sum + c.attr.str + c.attr.agi + c.attr.pow, 0) / Math.max(1, survivors.length * 0.8);
            teamPower += (Math.random() * 40); // ìš´

            if(teamPower >= threat.power) {
                addLog(`.. âœ… ìœ„í˜‘ì„ ë¬¼ë¦¬ì³¤ìŠµë‹ˆë‹¤! ì „ìš°ì• ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.`);
                survivors.forEach(c => {
                    updateResource(c, 'sanity', -5); // ì„±ê³µí•´ë„ ê³µí¬ëŠ” ë‚¨ìŒ
                    // ì „íˆ¬ ìŠ¹ë¦¬ ì‹œ ê´€ê³„ ì†Œí­ ìƒìŠ¹
                    survivors.forEach(target => {
                        if(c.id !== target.id) changeRel(c, target.name, 2);
                    });
                });
            } else {
                addLog(`.. âŒ ë§‰ì•„ë‚´ì§€ ëª»í–ˆìŠµë‹ˆë‹¤! í”¼í•´ê°€ ë°œìƒí•©ë‹ˆë‹¤.`);
                survivors.forEach(c => {
                    updateResource(c, 'hp', -20);
                    updateResource(c, 'sanity', -15);
                    // íŒ¨ë°° ì‹œ ì„œë¡œ íƒ“í•˜ë©° ê´€ê³„ í•˜ë½
                    survivors.forEach(target => {
                        if(c.id !== target.id) changeRel(c, target.name, -2);
                    });
                });
            }
        }

        // ==========================================
        // 4. ê´€ê³„ ì‹œë®¬ë ˆì´ì…˜ (í•µì‹¬ ê¸°ëŠ¥)
        // ==========================================
        function processSocial(survivors) {
            if(survivors.length < 2) {
                addLog(`<span class="txt-social">[ë…ë°±]</span> ${survivors[0].name}ì€(ëŠ”) í™€ë¡œ ì¤‘ì–¼ê±°ë¦½ë‹ˆë‹¤.`);
                updateResource(survivors[0], 'sanity', -2);
                return;
            }

            // ëœë¤ ë‘ ëª… ì„ ì •
            const idx1 = Math.floor(Math.random() * survivors.length);
            let idx2 = Math.floor(Math.random() * survivors.length);
            while(idx1 === idx2) idx2 = Math.floor(Math.random() * survivors.length);

            const c1 = survivors[idx1];
            const c2 = survivors[idx2];
            
            // MBTI ê¶í•© ê³„ì‚° (ê°™ì€ ê¸€ì ìˆ˜)
            let compatibility = 0;
            for(let i=0; i<4; i++) if(c1.mbti[i] === c2.mbti[i]) compatibility++;
            
            // íŠ¹ìˆ˜ ì¶©ëŒ ë¡œì§
            let conflictType = "";
            if(c1.mbti[2] !== c2.mbti[2]) conflictType = "TF"; // ì‚¬ê³  vs ê°ì •
            if(c1.mbti[3] !== c2.mbti[3]) conflictType = "JP"; // íŒë‹¨ vs ì¸ì‹

            // ì£¼ì‚¬ìœ„ êµ´ë¦¼ (ê¶í•© + ëœë¤ + í˜„ì¬ê´€ê³„)
            const currentRel = c1.relations[c2.name] || 0;
            const roll = (Math.random() * 100) + (compatibility * 5) + (currentRel * 0.5);

            // ë¡œì§ ë¶„ê¸°
            if(roll < 30) { 
                // [ê°ˆë“± ë°œìƒ]
                let msg = "";
                if(conflictType === "TF") msg = "ì„œë¡œì˜ ë§íˆ¬ê°€ ê±°ìŠ¬ë ¤ ë§ë‹¤íˆ¼ì„ í•©ë‹ˆë‹¤.";
                else if(conflictType === "JP") msg = "í–‰ë™ ë°©ì‹ì˜ ì°¨ì´ë¡œ ì§œì¦ì„ ëƒ…ë‹ˆë‹¤.";
                else msg = "ì‚¬ì†Œí•œ ì˜¤í•´ë¡œ ë¶„ìœ„ê¸°ê°€ í—˜ì•…í•´ì§‘ë‹ˆë‹¤.";
                
                addLog(`<span class="txt-clash">[ê°ˆë“±] <b>${c1.name}</b> vs <b>${c2.name}</b>: ${msg}</span>`);
                changeRel(c1, c2.name, -10);
                changeRel(c2, c1.name, -10);
                updateResource(c1, 'sanity', -5); // ìŠ¤íŠ¸ë ˆìŠ¤
            } 
            else if (roll > 70) {
                // [ìœ ëŒ€ ê°•í™”]
                addLog(`<span class="txt-bond">[ìœ ëŒ€] <b>${c1.name}</b>(ì™€)ê³¼ <b>${c2.name}</b>: ì„œë¡œì˜ ë“±ì„ ì§€ì¼œì£¼ê¸°ë¡œ ì•½ì†í•©ë‹ˆë‹¤.</span>`);
                changeRel(c1, c2.name, 10);
                changeRel(c2, c1.name, 10);
                updateResource(c1, 'sanity', 5); // ë©˜íƒˆ íšŒë³µ
                updateResource(c2, 'sanity', 5);
            }
            else {
                // [ì¼ìƒ ëŒ€í™”]
                addLog(`<span class="txt-social">[ëŒ€í™”] <b>${c1.name}</b>: <b>${c2.name}</b>ì—ê²Œ ìƒí™©ì„ ê³µìœ í•©ë‹ˆë‹¤.`);
                changeRel(c1, c2.name, 2);
                changeRel(c2, c1.name, 2);
            }
        }

        function changeRel(char, targetName, amount) {
            if(!char.relations[targetName]) char.relations[targetName] = 0;
            char.relations[targetName] += amount;
            // ê´€ê³„ë„ ì œí•œ (-100 ~ 100)
            char.relations[targetName] = Math.max(-100, Math.min(100, char.relations[targetName]));
        }

        // ==========================================
        // 5. ìœ í‹¸ë¦¬í‹° & UI
        // ==========================================
        function updateResource(char, type, amount) {
            if (char.resources.hp <= 0 && type !== 'hp') return;
            let maxKey = 'max' + type.charAt(0).toUpperCase() + type.slice(1);
            char.resources[type] = Math.max(0, Math.min(char.resources[maxKey], char.resources[type] + amount));
        }

        function requestItemUse(idx) {
            selectedItemIndex = idx;
            const item = partyInventory[idx];
            const modal = document.getElementById('item-modal');
            document.getElementById('modal-title').innerText = `[${item.name}] ì‚¬ìš©`;
            document.getElementById('modal-desc').innerText = `${item.desc}`;
            
            document.getElementById('modal-targets').innerHTML = characters.map(c => `
                <div class="target-btn ${c.resources.hp<=0?'dead':''}" onclick="confirmUseItem(${c.id})">
                    ${c.name}<br>HP:${c.resources.hp} SAN:${c.resources.sanity}
                </div>
            `).join('');
            modal.style.display = 'flex';
        }

        function confirmUseItem(charId) {
            if(selectedItemIndex === -1) return;
            const item = partyInventory[selectedItemIndex];
            const char = characters.find(c => c.id === charId);
            if(char) {
                updateResource(char, item.type, item.val);
                addLog(`<span class="txt-info">ğŸ’Š <b>${char.name}</b>ì—ê²Œ [${item.name}] ì‚¬ìš©.</span>`);
                partyInventory.splice(selectedItemIndex, 1);
            }
            closeModal(); updateUI();
        }

        function closeModal() { document.getElementById('item-modal').style.display = 'none'; selectedItemIndex = -1; }

        function updateUI() {
            const charDiv = document.getElementById('sim-char-list');
            charDiv.innerHTML = characters.map(c => {
                const isDead = c.resources.hp <= 0;
                const hpPct = Math.min(100, (c.resources.hp / c.resources.maxHp)*100);
                const sanPct = Math.min(100, (c.resources.sanity / c.resources.maxSanity)*100);
                const foodPct = Math.min(100, (c.resources.food / c.resources.maxFood)*100);
                
                let classes = "char-card";
                if(c.resources.sanity < 30) classes += " madness";
                if(c.resources.hp < 30) classes += " danger";
                
                // ê´€ê³„ ìš”ì•½ (ê°€ì¥ ë†’ì€/ë‚®ì€ ê´€ê³„)
                let relHtml = "<span style='color:#546e7a'>ê´€ê³„ ì—†ìŒ</span>";
                const rels = Object.entries(c.relations);
                if(rels.length > 0) {
                    // í˜¸ê°ë„ ìˆœ ì •ë ¬
                    rels.sort((a,b) => b[1] - a[1]);
                    const best = rels[0];
                    const worst = rels[rels.length-1];
                    relHtml = "";
                    if(best[1] > 10) relHtml += `<span class="rel-tag">ì¹œí•¨: ${best[0]} <span class="rel-val plus">(+${best[1]})</span></span>`;
                    if(worst[1] < -10) relHtml += `<span class="rel-tag">í˜ì˜¤: ${worst[0]} <span class="rel-val minus">(${worst[1]})</span></span>`;
                    if(relHtml === "") relHtml = "<span style='color:#546e7a'>ì¤‘ë¦½ì </span>";
                }

                if(isDead) return `<div class="char-card" style="opacity:0.4;"><div class="char-header"><span class="char-name">ğŸ’€ ${c.name}</span></div></div>`;

                return `
                <div class="${classes}">
                    <div class="char-header"><span class="char-name">${c.name}</span><span class="char-meta">${c.mbti}</span></div>
                    <div class="stat-row"><span>HP</span><div class="bar-bg"><div class="bar-fill" style="width:${hpPct}%; background:var(--hp-color)"></div></div><span>${c.resources.hp}</span></div>
                    <div class="stat-row"><span>SAN</span><div class="bar-bg"><div class="bar-fill" style="width:${sanPct}%; background:var(--san-color)"></div></div><span>${c.resources.sanity}</span></div>
                    <div class="stat-row"><span>FOOD</span><div class="bar-bg"><div class="bar-fill" style="width:${foodPct}%; background:var(--food-color)"></div></div><span>${c.resources.food}</span></div>
                    <div class="info-box">STR:${c.attr.str} AGI:${c.attr.agi} POW:${c.attr.pow} OBS:${c.attr.obs}</div>
                    <div class="rel-box">${relHtml}</div>
                </div>`;
            }).join('');

            const invDiv = document.getElementById('shared-inv');
            if(partyInventory.length === 0) invDiv.innerHTML = `<span style="color:#546e7a; font-size:0.9em; padding:10px;">ë¬¼ì ì—†ìŒ</span>`;
            else invDiv.innerHTML = partyInventory.map((item, idx) => `<button class="item-btn" onclick="requestItemUse(${idx})" title="${item.desc}">${item.name}</button>`).join('');
            
            const logWin = document.getElementById('log-window');
            logWin.scrollTop = logWin.scrollHeight;
        }

        function addLog(html) {
            const win = document.getElementById('log-window');
            const div = document.createElement('div'); div.className = 'log-entry'; div.innerHTML = html;
            win.appendChild(div);
        }
        
        checkPoints();
    </script>
</body>
</html>
