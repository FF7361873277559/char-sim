<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>MBTI ìºë¦­í„° ì‹œë®¬ë ˆì´í„° (ìŠ¤íƒ¯ ì»¤ìŠ¤í…€)</title>
    <style>
        /* 1. ë””ìì¸: ì‚°ëœ»í•˜ê³  ë°ì€ ëŠë‚Œ (Sky Blue & White) */
        :root {
            --primary: #4a90e2;
            --bg-color: #f0f9ff;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --log-bg: #ffffff;
        }

        body { font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); }
        h1, h2 { color: var(--primary); margin-bottom: 10px; }
        
        /* ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* í˜ì´ì§€ ì „í™˜ìš© í´ë˜ìŠ¤ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-section { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end; }
        .input-box { flex: 1; }
        
        label { display: block; font-weight: bold; font-size: 0.9em; color: var(--text-sub); margin-bottom: 5px; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        /* ìŠ¤íƒ¯ ë¶„ë°° ìŠ¤íƒ€ì¼ */
        .stat-dist-box { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-input-group label { font-size: 0.8em; text-align: center; }
        .stat-input-group input { width: 100%; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 5px; }
        .remain-point { text-align: right; font-size: 0.9em; margin-bottom: 5px; font-weight: bold; }
        .remain-point span { color: var(--primary); font-size: 1.2em; }
        .error-msg { color: #e74c3c; font-size: 0.9em; display: none; margin-top: 5px; font-weight: bold;}

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-secondary { background-color: #e2e8f0; color: #333; }
        .btn-sm { padding: 8px 15px; width: auto; }

        /* ìºë¦­í„° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        .char-card { background: #fafafa; border: 1px solid #eee; padding: 15px; border-radius: 10px; position: relative; }
        .char-name { font-size: 1.2em; font-weight: bold; color: #333; }
        .char-mbti { font-size: 0.9em; color: var(--primary); font-weight: bold; }
        .stat-row { display: flex; justify-content: space-between; font-size: 0.8em; color: #555; margin-top: 5px; }
        .bar-bg { background: #eee; height: 6px; border-radius: 3px; margin-top: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        /* ë¡œê·¸ ìŠ¤íƒ€ì¼ */
        #log-window { height: 400px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-top: 20px; font-size: 0.95em; line-height: 1.6; }
        .log-entry { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #e0e0e0; }
        .log-day { font-weight: bold; color: var(--primary); margin-top: 15px; display: block; background: #eaf4ff; padding: 5px 10px; border-radius: 5px; }
        .tag-event { color: #e67e22; font-weight: bold; } 
    </style>
</head>
<body>

    <div class="container">
        <div id="page-setup" class="page active">
            <h1>ğŸ“ ìºë¦­í„° ë“±ë¡ì†Œ</h1>
            <p>ì´ë¦„ê³¼ MBTIë¥¼ ì…ë ¥í•˜ê³ , ì¶”ê°€ ìŠ¤íƒ¯ 100í¬ì¸íŠ¸ë¥¼ ë¶„ë°°í•˜ì„¸ìš”.</p>
            
            <div class="input-section">
                <div class="input-group">
                    <div class="input-box">
                        <label>ì´ë¦„</label>
                        <input type="text" id="input-name" placeholder="ì˜ˆ: ê¹€ì² ìˆ˜">
                    </div>
                    <div class="input-box">
                        <label>MBTI</label>
                        <select id="input-mbti">
                            <option value="ISTJ">ISTJ (ê´€ë¦¬ì)</option>
                            <option value="ISFJ">ISFJ (ìˆ˜í˜¸ì)</option>
                            <option value="INFJ">INFJ (ì„ ì§€ì)</option>
                            <option value="INTJ">INTJ (ì „ëµê°€)</option>
                            <option value="ISTP">ISTP (ì¬ì£¼ê¾¼)</option>
                            <option value="ISFP">ISFP (ì˜ˆìˆ ê°€)</option>
                            <option value="INFP">INFP (ì¤‘ì¬ì)</option>
                            <option value="INTP">INTP (ì‚¬ìƒ‰ê°€)</option>
                            <option value="ESTP">ESTP (ì‚¬ì—…ê°€)</option>
                            <option value="ESFP">ESFP (ììœ ì¸)</option>
                            <option value="ENFP">ENFP (í™œë™ê°€)</option>
                            <option value="ENTP">ENTP (ë³€ë¡ ê°€)</option>
                            <option value="ESTJ">ESTJ (ê²½ì˜ì)</option>
                            <option value="ESFJ">ESFJ (ì™¸êµê´€)</option>
                            <option value="ENFJ">ENFJ (ìš´ë™ê°€)</option>
                            <option value="ENTJ">ENTJ (í†µì†”ì)</option>
                        </select>
                    </div>
                </div>

                <div class="remain-point">ë‚¨ì€ í¬ì¸íŠ¸: <span id="remain-val">100</span> / 100</div>
                <div class="stat-dist-box">
                    <div class="stat-input-group">
                        <label>ê·¼ë ¥</label>
                        <input type="number" id="stat-str" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>ìˆœë°œë ¥</label>
                        <input type="number" id="stat-agi" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>ê³µê²©ì„±</label>
                        <input type="number" id="stat-agg" value="0" min="0" oninput="checkPoints()">
                    </div>
                    <div class="stat-input-group">
                        <label>ëŠ¥ë™ì„±</label>
                        <input type="number" id="stat-act" value="0" min="0" oninput="checkPoints()">
                    </div>
                </div>
                <div id="point-error" class="error-msg">âš ï¸ í¬ì¸íŠ¸ í•©ê³„ê°€ 100ì´ì–´ì•¼ í•©ë‹ˆë‹¤!</div>
                <br>
                <button class="btn-primary" onclick="addCharacter()">ìºë¦­í„° ë“±ë¡</button>
            </div>

            <div id="char-list" class="char-grid">
                </div>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
            <button class="btn-primary" style="background:#2ecc71;" onclick="startGame()">ğŸš€ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘í•˜ê¸°</button>
        </div>

        <div id="page-sim" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>ğŸ“º ìƒí™© ì‹œë®¬ë ˆì´í„°</h1>
                <button class="btn-secondary btn-sm" onclick="stopGame()">âš™ï¸ ê´€ë¦¬ í™”ë©´ìœ¼ë¡œ</button>
            </div>
            
            <div style="display:flex; gap:10px; margin-bottom:10px; margin-top:10px;">
                <button class="btn-primary" onclick="nextTurn()">ğŸ“… 1ì¼ ì§„í–‰ (ë‹¤ìŒ í„´)</button>
                <button class="btn-secondary" onclick="autoPlay()">â© ìë™ ì§„í–‰</button>
            </div>

            <div id="log-window">
                <div class="log-entry" style="color:#999;">ìºë¦­í„°ë“¤ì´ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤... '1ì¼ ì§„í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            </div>

            <h3>ğŸ“Š í˜„ì¬ ìƒì¡´ì í˜„í™©</h3>
            <div id="sim-status" class="char-grid">
                </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. í¬ì¸íŠ¸ ë¶„ë°° ë¡œì§
        // ==========================================
        const MAX_POINT = 100;

        function checkPoints() {
            const str = Number(document.getElementById('stat-str').value) || 0;
            const agi = Number(document.getElementById('stat-agi').value) || 0;
            const agg = Number(document.getElementById('stat-agg').value) || 0;
            const act = Number(document.getElementById('stat-act').value) || 0;

            const total = str + agi + agg + act;
            const remain = MAX_POINT - total;

            const remainSpan = document.getElementById('remain-val');
            remainSpan.innerText = remain;

            if (remain < 0) {
                remainSpan.style.color = "red";
                document.getElementById('point-error').style.display = "block";
                document.getElementById('point-error').innerText = `âš ï¸ í¬ì¸íŠ¸ ì´ˆê³¼! (${Math.abs(remain)}ì  ì¤„ì´ì„¸ìš”)`;
            } else if (remain > 0) {
                remainSpan.style.color = "#4a90e2";
                document.getElementById('point-error').style.display = "none";
            } else {
                remainSpan.style.color = "green"; // ë”± 0ì¼ ë•Œ
                document.getElementById('point-error').style.display = "none";
            }
            return remain; // ë“±ë¡ ë²„íŠ¼ì—ì„œ í™•ì¸ìš©
        }

        // ==========================================
        // 2. ë°ì´í„° êµ¬ì¡° ë° ì„¤ì •
        // ==========================================
        let characters = []; 
        let day = 0; 
        let isAutoPlaying = false;

        // MBTI ìŠ¤íƒ¯ + ì‚¬ìš©ì ë°°ë¶„ ìŠ¤íƒ¯ í•©ì‚°
        function calculateStats(mbti, bonusStats) {
            // ê¸°ë³¸ ë² ì´ìŠ¤
            let stats = {
                hp: 100, maxHp: 100,
                sanity: 100, maxSanity: 100,
                stamina: 100, maxStamina: 100,
                
                // ê¸°ë³¸ê°’ 30 + MBTI ë³´ë„ˆìŠ¤
                strength: 30, 
                agility: 30,  
                aggro: 30,    
                active: 30,   
                conscience: 50 
            };

            // MBTI í•´ì„ ë¡œì§
            const chars = mbti.split('');
            if (chars[0] === 'E') stats.active += 40; else stats.sanity += 20;
            if (chars[1] === 'S') stats.stamina += 30; else stats.conscience += 20;
            if (chars[2] === 'T') stats.aggro += 40; else stats.conscience += 30;
            if (chars[3] === 'J') stats.strength += 30; else stats.agility += 30;

            // ì‚¬ìš©ì ì§€ì • ë³´ë„ˆìŠ¤ í¬ì¸íŠ¸ í•©ì‚°
            stats.strength += bonusStats.str;
            stats.agility += bonusStats.agi;
            stats.aggro += bonusStats.agg;
            stats.active += bonusStats.act;

            return stats;
        }

        // ==========================================
        // 3. ìºë¦­í„° ê´€ë¦¬ ë¡œì§
        // ==========================================
        function addCharacter() {
            const name = document.getElementById('input-name').value;
            const mbti = document.getElementById('input-mbti').value;
            
            // í¬ì¸íŠ¸ ê²€ì¦
            const remain = checkPoints();
            if (remain !== 0) {
                alert("ì¶”ê°€ í¬ì¸íŠ¸ í•©ê³„ê°€ ì •í™•íˆ 100ì´ì–´ì•¼ í•©ë‹ˆë‹¤!");
                return;
            }

            if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            const bonusStats = {
                str: Number(document.getElementById('stat-str').value),
                agi: Number(document.getElementById('stat-agi').value),
                agg: Number(document.getElementById('stat-agg').value),
                act: Number(document.getElementById('stat-act').value)
            };

            const stats = calculateStats(mbti, bonusStats);
            
            const newChar = {
                id: Date.now(),
                name: name,
                mbti: mbti,
                stats: stats,
                relations: {} 
            };

            characters.push(newChar);
            renderCharList();
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('input-name').value = ''; 
            document.getElementById('stat-str').value = 0;
            document.getElementById('stat-agi').value = 0;
            document.getElementById('stat-agg').value = 0;
            document.getElementById('stat-act').value = 0;
            checkPoints(); // í¬ì¸íŠ¸ í‘œì‹œ ì´ˆê¸°í™”
        }

        function renderCharList() {
            const list = document.getElementById('char-list');
            list.innerHTML = characters.map(c => `
                <div class="char-card">
                    <div class="char-name">${c.name}</div>
                    <div class="char-mbti">${c.mbti}</div>
                    <div class="stat-row"><span>ì²´ë ¥</span> <span>${c.stats.hp}/${c.stats.maxHp}</span></div>
                    <div class="stat-row"><span>ì •ì‹ ë ¥: ${c.stats.sanity}</span> <span>ê³µê²©ì„±: ${c.stats.aggro}</span></div>
                    <div class="stat-row"><span>ê·¼ë ¥: ${c.stats.strength}</span> <span>ìˆœë°œë ¥: ${c.stats.agility}</span></div>
                    <div class="stat-row"><span>ëŠ¥ë™ì„±: ${c.stats.active}</span> <span>ì–‘ì‹¬: ${c.stats.conscience}</span></div>
                </div>
            `).join('');
        }

        // ==========================================
        // 4. ì‹œë®¬ë ˆì´ì…˜ ì—”ì§„
        // ==========================================
        function startGame() {
            if (characters.length < 2) return alert("ìµœì†Œ 2ëª…ì˜ ìºë¦­í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤!");
            
            characters.forEach(c1 => {
                characters.forEach(c2 => {
                    if (c1.id !== c2.id) {
                        if (!c1.relations[c2.name]) c1.relations[c2.name] = 0;
                    }
                });
            });

            document.getElementById('page-setup').classList.remove('active');
            document.getElementById('page-sim').classList.add('active');
            addLog(`ğŸ“¢ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤. ì°¸ê°€ì: ${characters.length}ëª…`);
            updateSimStatus();
        }

        function stopGame() {
            document.getElementById('page-sim').classList.remove('active');
            document.getElementById('page-setup').classList.add('active');
            isAutoPlaying = false;
        }

        function nextTurn() {
            day++;
            addLog(`<span class="log-day">ğŸŒ ${day}ì¼ì°¨ ì•„ì¹¨ì´ ë°ì•˜ìŠµë‹ˆë‹¤.</span>`);

            const survivors = characters.filter(c => c.stats.hp > 0);
            if (survivors.length < 1) {
                addLog("ğŸ’€ ìƒì¡´ìê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œë®¬ë ˆì´ì…˜ ì¢…ë£Œ.");
                return;
            }

            // ëŠ¥ë™ì„±ì´ ë†’ì€ ìºë¦­í„°ì¼ìˆ˜ë¡ ì´ë²¤íŠ¸ ì£¼ì²´ê°€ ë  í™•ë¥  ë†’ì„ (ê°€ì¤‘ì¹˜ ëœë¤)
            // ê°„ë‹¨í•˜ê²Œ: ì´ë²¤íŠ¸ íšŸìˆ˜ ì‚°ì •
            const eventCount = Math.max(1, Math.floor(survivors.length / 2));
            
            for(let i=0; i<eventCount; i++) {
                // ì£¼ì²´ ì„ ì • (ë‹¨ìˆœ ëœë¤)
                const actor = survivors[Math.floor(Math.random() * survivors.length)];
                let target = survivors[Math.floor(Math.random() * survivors.length)];
                
                while(survivors.length > 1 && actor.id === target.id) {
                    target = survivors[Math.floor(Math.random() * survivors.length)];
                }
                processEvent(actor, target);
            }
            updateSimStatus();
        }

        function processEvent(actor, target) {
            // í˜¼ì í–‰ë™
            if (actor.id === target.id) {
                const recovery = 10;
                heal(actor, 'hp', recovery);
                heal(actor, 'stamina', 10);
                addLog(`ğŸ’¤ <b>${actor.name}</b>(ì€)ëŠ” íœ´ì‹ì„ ì·¨í•˜ë©° ì²´ë ¥ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤.`);
                return;
            }

            const relation = actor.relations[target.name] || 0;
            const dice = Math.random() * 100;
            
            // 1. ê³µê²© ì´ë²¤íŠ¸ (í˜¸ê°ë„ ë‚®ê±°ë‚˜, ê³µê²©ì„± ë†’ìŒ)
            // ì¡°ê±´: í˜¸ê°ë„ -20 ë¯¸ë§Œì´ê±°ë‚˜, (ê³µê²©ì„± > 70 ì´ê³  ì£¼ì‚¬ìœ„ < 50)
            if (relation < -20 || (actor.stats.aggro > 70 && dice < 50)) {
                addLog(`<span class="tag-event" style="color:red;">[ì¶©ëŒ]</span> <b>${actor.name}</b>(ì´)ê°€ <b>${target.name}</b>ì—ê²Œ ì‹¸ì›€ì„ ê²ë‹ˆë‹¤!`);
                
                // ì „íˆ¬ë ¥ íŒì • (ê·¼ë ¥+ìˆœë°œë ¥+ê³µê²©ì„±) vs (ê·¼ë ¥+ìˆœë°œë ¥+ì§€êµ¬ë ¥)
                const actorPower = actor.stats.strength + actor.stats.agility + actor.stats.aggro + (Math.random()*30);
                const targetPower = target.stats.strength + target.stats.agility + target.stats.stamina + (Math.random()*30);

                if (actorPower > targetPower) {
                    // ê³µê²© ì„±ê³µ
                    const dmg = Math.floor(actor.stats.strength / 2) + 5;
                    damage(target, dmg);
                    changeRelation(actor, target, -10);
                    changeRelation(target, actor, -20);
                    addLog(`Result: ğŸ—¡ï¸ <b>${actor.name}</b>ì˜ ìŠ¹ë¦¬! ${target.name}ì—ê²Œ ${dmg}ì˜ í”¼í•´ë¥¼ ì…í˜”ìŠµë‹ˆë‹¤.`);
                } else {
                    // ë°˜ê²©/íšŒí”¼
                    addLog(`Result: ğŸ›¡ï¸ <b>${target.name}</b>(ì´)ê°€ ê³µê²©ì„ ê°€ë³ê²Œ í”¼í–ˆìŠµë‹ˆë‹¤. ${
